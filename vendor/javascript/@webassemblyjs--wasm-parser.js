import e from"@webassemblyjs/helper-api-error";import t from"@webassemblyjs/ieee754";import r from"@webassemblyjs/utf8";import n from"@webassemblyjs/ast";import a from"@webassemblyjs/leb128";import o from"@webassemblyjs/helper-wasm-bytecode";import i from"buffer";var u={};var d=i.Buffer;Object.defineProperty(u,"__esModule",{value:true});u.decode=decode;var s=e;var c=_interopRequireWildcard(t);var l=_interopRequireWildcard(r);var v=_interopRequireWildcard(n);var p=a;var f=_interopRequireDefault(o);function _interopRequireDefault(e){return e&&e.__esModule?e:{default:e}}function _interopRequireWildcard(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var r in e)if(Object.prototype.hasOwnProperty.call(e,r)){var n=Object.defineProperty&&Object.getOwnPropertyDescriptor?Object.getOwnPropertyDescriptor(e,r):{};n.get||n.set?Object.defineProperty(t,r,n):t[r]=e[r]}t.default=e;return t}function _toConsumableArray(e){if(Array.isArray(e)){for(var t=0,r=new Array(e.length);t<e.length;t++)r[t]=e[t];return r}return Array.from(e)}function toHex(e){return"0x"+Number(e).toString(16)}function byteArrayEq(e,t){if(e.length!==t.length)return false;for(var r=0;r<e.length;r++)if(e[r]!==t[r])return false;return true}function decode(e,t){var r=new Uint8Array(e);var n=v.getUniqueNameGenerator();var a=0;function getPosition(){return{line:-1,column:a}}function dump(e,r){if(false!==t.dump){var n="\t\t\t\t\t\t\t\t\t\t";var o="";o=e.length<5?e.map(toHex).join(" "):"...";console.log(toHex(a)+":\t",o,n,";",r)}}function dumpSep(e){false!==t.dump&&console.log(";",e)}var o={elementsInFuncSection:[],elementsInExportSection:[],elementsInCodeSection:[],memoriesInModule:[],typesInModule:[],functionsInModule:[],tablesInModule:[],globalsInModule:[]};function isEOF(){return a>=r.length}function eatBytes(e){a+=e}function readBytesAtOffset(e,t){var n=[];for(var a=0;a<t;a++)n.push(r[e+a]);return n}function readBytes(e){return readBytesAtOffset(a,e)}function readF64(){var e=readBytes(c.NUMBER_OF_BYTE_F64);var t=c.decodeF64(e);if(Math.sign(t)*t===Infinity)return{value:Math.sign(t),inf:true,nextIndex:c.NUMBER_OF_BYTE_F64};if(isNaN(t)){var r=e[e.length-1]>>7?-1:1;var n=0;for(var a=0;a<e.length-2;++a)n+=e[a]*Math.pow(256,a);n+=e[e.length-2]%16*Math.pow(256,e.length-2);return{value:r*n,nan:true,nextIndex:c.NUMBER_OF_BYTE_F64}}return{value:t,nextIndex:c.NUMBER_OF_BYTE_F64}}function readF32(){var e=readBytes(c.NUMBER_OF_BYTE_F32);var t=c.decodeF32(e);if(Math.sign(t)*t===Infinity)return{value:Math.sign(t),inf:true,nextIndex:c.NUMBER_OF_BYTE_F32};if(isNaN(t)){var r=e[e.length-1]>>7?-1:1;var n=0;for(var a=0;a<e.length-2;++a)n+=e[a]*Math.pow(256,a);n+=e[e.length-2]%128*Math.pow(256,e.length-2);return{value:r*n,nan:true,nextIndex:c.NUMBER_OF_BYTE_F32}}return{value:t,nextIndex:c.NUMBER_OF_BYTE_F32}}function readUTF8String(){var e=readU32();var t=e.value;dump([t],"string length");var r=readBytesAtOffset(a+e.nextIndex,t);var n=l.decode(r);return{value:n,nextIndex:t+e.nextIndex}}function readU32(){var e=readBytes(p.MAX_NUMBER_OF_BYTE_U32);var t=d.from(e);return(0,p.decodeUInt32)(t)}function readVaruint32(){var e=readBytes(4);var t=d.from(e);return(0,p.decodeUInt32)(t)}function readVaruint7(){var e=readBytes(1);var t=d.from(e);return(0,p.decodeUInt32)(t)}function read32(){var e=readBytes(p.MAX_NUMBER_OF_BYTE_U32);var t=d.from(e);return(0,p.decodeInt32)(t)}function read64(){var e=readBytes(p.MAX_NUMBER_OF_BYTE_U64);var t=d.from(e);return(0,p.decodeInt64)(t)}function readU64(){var e=readBytes(p.MAX_NUMBER_OF_BYTE_U64);var t=d.from(e);return(0,p.decodeUInt64)(t)}function readByte(){return readBytes(1)[0]}function parseModuleHeader(){if(true===isEOF()||a+4>r.length)throw new Error("unexpected end");var e=readBytes(4);if(false===byteArrayEq(f.default.magicModuleHeader,e))throw new s.CompileError("magic header not detected");dump(e,"wasm magic header");eatBytes(4)}function parseVersion(){if(true===isEOF()||a+4>r.length)throw new Error("unexpected end");var e=readBytes(4);if(false===byteArrayEq(f.default.moduleVersion,e))throw new s.CompileError("unknown binary version");dump(e,"wasm version");eatBytes(4)}function parseVec(e){var t=readU32();var r=t.value;eatBytes(t.nextIndex);dump([r],"number");if(0===r)return[];var n=[];for(var a=0;a<r;a++){var o=readByte();eatBytes(1);var i=e(o);dump([o],i);if("undefined"===typeof i)throw new s.CompileError("Internal failure: parseVec could not cast the value");n.push(i)}return n}function parseTypeSection(e){var t=[];dump([e],"num types");for(var r=0;r<e;r++){var n=getPosition();dumpSep("type "+r);var a=readByte();eatBytes(1);if(a!=f.default.types.func)throw new Error("Unsupported type: "+toHex(a));dump([a],"func");var i=parseVec((function(e){return f.default.valtypes[e]}));var u=i.map((function(e){return v.funcParam(e)}));var d=parseVec((function(e){return f.default.valtypes[e]}));t.push(function(){var e=getPosition();return v.withLoc(v.typeInstruction(void 0,v.signature(u,d)),e,n)}());o.typesInModule.push({params:u,result:d})}return t}function parseImportSection(e){var t=[];for(var r=0;r<e;r++){dumpSep("import header "+r);var a=getPosition();var i=readUTF8String();eatBytes(i.nextIndex);dump([],"module name (".concat(i.value,")"));var u=readUTF8String();eatBytes(u.nextIndex);dump([],"name (".concat(u.value,")"));var d=readByte();eatBytes(1);var c=f.default.importTypes[d];dump([d],"import kind");if("undefined"===typeof c)throw new s.CompileError("Unknown import description type: "+toHex(d));var l=void 0;if("func"===c){var p=readU32();var m=p.value;eatBytes(p.nextIndex);dump([m],"type index");var y=o.typesInModule[m];if("undefined"===typeof y)throw new s.CompileError("function signature not found (".concat(m,")"));var x=n("func");l=v.funcImportDescr(x,v.signature(y.params,y.result));o.functionsInModule.push({id:v.identifier(u.value),signature:y,isExternal:true})}else if("global"===c){l=parseGlobalType();var g=v.global(l,[]);o.globalsInModule.push(g)}else if("table"===c)l=parseTableType(r);else{if("mem"!==c)throw new s.CompileError("Unsupported import of type: "+c);var h=parseMemoryType(0);o.memoriesInModule.push(h);l=h}t.push(function(){var e=getPosition();return v.withLoc(v.moduleImport(i.value,u.value,l),e,a)}())}return t}function parseFuncSection(e){dump([e],"num funcs");for(var t=0;t<e;t++){var r=readU32();var a=r.value;eatBytes(r.nextIndex);dump([a],"type index");var i=o.typesInModule[a];if("undefined"===typeof i)throw new s.CompileError("function signature not found (".concat(a,")"));var u=v.withRaw(v.identifier(n("func")),"");o.functionsInModule.push({id:u,signature:i,isExternal:false})}}function parseExportSection(e){dump([e],"num exports");for(var t=0;t<e;t++){var r=getPosition();var n=readUTF8String();eatBytes(n.nextIndex);dump([],"export name (".concat(n.value,")"));var a=readByte();eatBytes(1);dump([a],"export kind");var i=readU32();var u=i.value;eatBytes(i.nextIndex);dump([u],"export index");var d=void 0,c=void 0;if("Func"===f.default.exportTypes[a]){var l=o.functionsInModule[u];if("undefined"===typeof l)throw new s.CompileError("unknown function (".concat(u,")"));d=v.numberLiteralFromRaw(u,String(u));c=l.signature}else if("Table"===f.default.exportTypes[a]){var p=o.tablesInModule[u];if("undefined"===typeof p)throw new s.CompileError("unknown table ".concat(u));d=v.numberLiteralFromRaw(u,String(u));c=null}else if("Mem"===f.default.exportTypes[a]){var m=o.memoriesInModule[u];if("undefined"===typeof m)throw new s.CompileError("unknown memory ".concat(u));d=v.numberLiteralFromRaw(u,String(u));c=null}else{if("Global"!==f.default.exportTypes[a]){console.warn("Unsupported export type: "+toHex(a));return}var y=o.globalsInModule[u];if("undefined"===typeof y)throw new s.CompileError("unknown global ".concat(u));d=v.numberLiteralFromRaw(u,String(u));c=null}var x=getPosition();o.elementsInExportSection.push({name:n.value,type:f.default.exportTypes[a],signature:c,id:d,index:u,endLoc:x,startLoc:r})}}function parseCodeSection(e){dump([e],"number functions");for(var t=0;t<e;t++){var r=getPosition();dumpSep("function body "+t);var n=readU32();eatBytes(n.nextIndex);dump([n.value],"function body size");var a=[];var i=readU32();var u=i.value;eatBytes(i.nextIndex);dump([u],"num locals");var d=[];for(var c=0;c<u;c++){var l=getPosition();var p=readU32();var m=p.value;eatBytes(p.nextIndex);dump([m],"num local");var y=readByte();eatBytes(1);var x=f.default.valtypes[y];var g=[];for(var h=0;h<m;h++)g.push(v.valtypeLiteral(x));var I=function(){var e=getPosition();return v.withLoc(v.instruction("local",g),e,l)}();d.push(I);dump([y],x);if("undefined"===typeof x)throw new s.CompileError("Unexpected valtype: "+toHex(y))}a.push.apply(a,d);parseInstructionBlock(a);var w=getPosition();o.elementsInCodeSection.push({code:a,locals:d,endLoc:w,startLoc:r,bodySize:n.value})}}function parseInstructionBlock(e){while(true){var t=getPosition();var r=false;var a=readByte();eatBytes(1);if(254===a)throw new s.CompileError("Atomic instructions are not implemented");var i=f.default.symbolsByByte[a];if("undefined"===typeof i)throw new s.CompileError("Unexpected instruction: "+toHex(a));"string"===typeof i.object?dump([a],"".concat(i.object,".").concat(i.name)):dump([a],i.name);if("end"===i.name){var u=function(){var e=getPosition();return v.withLoc(v.instruction(i.name),e,t)}();e.push(u);break}var d=[];if("loop"===i.name){var c=getPosition();var l=readByte();eatBytes(1);var p=f.default.blockTypes[l];dump([l],"blocktype");if("undefined"===typeof p)throw new s.CompileError("Unexpected blocktype: "+toHex(l));var m=[];parseInstructionBlock(m);var y=v.withRaw(v.identifier(n("loop")),"");var x=function(){var e=getPosition();return v.withLoc(v.loopInstruction(y,p,m),e,c)}();e.push(x);r=true}else if("if"===i.name){var g=getPosition();var h=readByte();eatBytes(1);var I=f.default.blockTypes[h];dump([h],"blocktype");if("undefined"===typeof I)throw new s.CompileError("Unexpected blocktype: "+toHex(h));var w=v.withRaw(v.identifier(n("if")),"");var b=[];parseInstructionBlock(b);var B=0;for(B=0;B<b.length;++B){var S=b[B];if("Instr"===S.type&&"else"===S.id)break}var M=b.slice(0,B);var U=b.slice(B+1);var E=[];var F=function(){var e=getPosition();return v.withLoc(v.ifInstruction(w,E,I,M,U),e,g)}();e.push(F);r=true}else if("block"===i.name){var L=getPosition();var _=readByte();eatBytes(1);var P=f.default.blockTypes[_];dump([_],"blocktype");if("undefined"===typeof P)throw new s.CompileError("Unexpected blocktype: "+toHex(_));var N=[];parseInstructionBlock(N);var T=v.withRaw(v.identifier(n("block")),"");var C=function(){var e=getPosition();return v.withLoc(v.blockInstruction(T,N,P),e,L)}();e.push(C);r=true}else if("call"===i.name){var R=readU32();var O=R.value;eatBytes(R.nextIndex);dump([O],"index");var k=function(){var e=getPosition();return v.withLoc(v.callInstruction(v.indexLiteral(O)),e,t)}();e.push(k);r=true}else if("call_indirect"===i.name){var j=getPosition();var A=readU32();var H=A.value;eatBytes(A.nextIndex);dump([H],"type index");var z=o.typesInModule[H];if("undefined"===typeof z)throw new s.CompileError("call_indirect signature not found (".concat(H,")"));var V=v.callIndirectInstruction(v.signature(z.params,z.result),[]);var D=readU32();var q=D.value;eatBytes(D.nextIndex);if(0!==q)throw new s.CompileError("zero flag expected");e.push(function(){var e=getPosition();return v.withLoc(V,e,j)}());r=true}else if("br_table"===i.name){var Y=readU32();var G=Y.value;eatBytes(Y.nextIndex);dump([G],"num indices");for(var W=0;W<=G;W++){var $=readU32();var X=$.value;eatBytes($.nextIndex);dump([X],"index");d.push(v.numberLiteralFromRaw($.value.toString(),"u32"))}}else if(a>=40&&a<=64)if("grow_memory"===i.name||"current_memory"===i.name){var J=readU32();var K=J.value;eatBytes(J.nextIndex);if(0!==K)throw new Error("zero flag expected");dump([K],"index")}else{var Q=readU32();var Z=Q.value;eatBytes(Q.nextIndex);dump([Z],"align");var ee=readU32();var te=ee.value;eatBytes(ee.nextIndex);dump([te],"offset")}else if(a>=65&&a<=68){if("i32"===i.object){var re=read32();var ne=re.value;eatBytes(re.nextIndex);dump([ne],"i32 value");d.push(v.numberLiteralFromRaw(ne))}if("u32"===i.object){var ae=readU32();var oe=ae.value;eatBytes(ae.nextIndex);dump([oe],"u32 value");d.push(v.numberLiteralFromRaw(oe))}if("i64"===i.object){var ie=read64();var ue=ie.value;eatBytes(ie.nextIndex);dump([Number(ue.toString())],"i64 value");var de=ue.high,se=ue.low;var ce={type:"LongNumberLiteral",value:{high:de,low:se}};d.push(ce)}if("u64"===i.object){var le=readU64();var ve=le.value;eatBytes(le.nextIndex);dump([Number(ve.toString())],"u64 value");var pe=ve.high,fe=ve.low;var me={type:"LongNumberLiteral",value:{high:pe,low:fe}};d.push(me)}if("f32"===i.object){var ye=readF32();var xe=ye.value;eatBytes(ye.nextIndex);dump([xe],"f32 value");d.push(v.floatLiteral(xe,ye.nan,ye.inf,String(xe)))}if("f64"===i.object){var ge=readF64();var he=ge.value;eatBytes(ge.nextIndex);dump([he],"f64 value");d.push(v.floatLiteral(he,ge.nan,ge.inf,String(he)))}}else for(var Ie=0;Ie<i.numberOfArgs;Ie++){var we=readU32();eatBytes(we.nextIndex);dump([we.value],"argument "+Ie);d.push(v.numberLiteralFromRaw(we.value))}if(false===r)if("string"===typeof i.object){var be=function(){var e=getPosition();return v.withLoc(v.objectInstruction(i.name,i.object,d),e,t)}();e.push(be)}else{var Be=function(){var e=getPosition();return v.withLoc(v.instruction(i.name,d),e,t)}();e.push(Be)}}}function parseLimits(){var e=readByte();eatBytes(1);dump([e],"limit type");var t,r;if(1===e||3===e){var n=readU32();t=parseInt(n.value);eatBytes(n.nextIndex);dump([t],"min");var a=readU32();r=parseInt(a.value);eatBytes(a.nextIndex);dump([r],"max")}if(0===e){var o=readU32();t=parseInt(o.value);eatBytes(o.nextIndex);dump([t],"min")}return v.limit(t,r)}function parseTableType(e){var t=v.withRaw(v.identifier(n("table")),String(e));var r=readByte();eatBytes(1);dump([r],"element type");var a=f.default.tableTypes[r];if("undefined"===typeof a)throw new s.CompileError("Unknown element type in table: "+toHex(a));var o=parseLimits();return v.table(a,o,t)}function parseGlobalType(){var e=readByte();eatBytes(1);var t=f.default.valtypes[e];dump([e],t);if("undefined"===typeof t)throw new s.CompileError("Unknown valtype: "+toHex(e));var r=readByte();eatBytes(1);var n=f.default.globalTypes[r];dump([r],"global type (".concat(n,")"));if("undefined"===typeof n)throw new s.CompileError("Invalid mutability: "+toHex(r));return v.globalType(t,n)}function parseNameSectionFunctions(){var e=[];var t=readU32();var r=t.value;eatBytes(t.nextIndex);for(var n=0;n<r;n++){var a=readU32();var o=a.value;eatBytes(a.nextIndex);var i=readUTF8String();eatBytes(i.nextIndex);e.push(v.functionNameMetadata(i.value,o))}return e}function parseNameSectionLocals(){var e=[];var t=readU32();var r=t.value;eatBytes(t.nextIndex);for(var n=0;n<r;n++){var a=readU32();var o=a.value;eatBytes(a.nextIndex);var i=readU32();var u=i.value;eatBytes(i.nextIndex);for(var d=0;d<u;d++){var s=readU32();var c=s.value;eatBytes(s.nextIndex);var l=readUTF8String();eatBytes(l.nextIndex);e.push(v.localNameMetadata(l.value,c,o))}}return e}function parseNameSection(e){var t=[];var r=a;while(a-r<e){var n=readVaruint7();eatBytes(n.nextIndex);var o=readVaruint32();eatBytes(o.nextIndex);switch(n.value){case 1:t.push.apply(t,_toConsumableArray(parseNameSectionFunctions()));break;case 2:t.push.apply(t,_toConsumableArray(parseNameSectionLocals()));break;default:eatBytes(o.value)}}return t}function parseProducersSection(){var e=v.producersSectionMetadata([]);var t=readVaruint32();eatBytes(t.nextIndex);dump([t.value],"num of producers");var r={language:[],"processed-by":[],sdk:[]};for(var n=0;n<t.value;n++){var a=readUTF8String();eatBytes(a.nextIndex);var o=readVaruint32();eatBytes(o.nextIndex);for(var i=0;i<o.value;i++){var u=readUTF8String();eatBytes(u.nextIndex);var d=readUTF8String();eatBytes(d.nextIndex);r[a.value].push(v.producerMetadataVersionedName(u.value,d.value))}e.producers.push(r[a.value])}return e}function parseGlobalSection(e){var t=[];dump([e],"num globals");for(var r=0;r<e;r++){var n=getPosition();var a=parseGlobalType();var i=[];parseInstructionBlock(i);var u=function(){var e=getPosition();return v.withLoc(v.global(a,i),e,n)}();t.push(u);o.globalsInModule.push(u)}return t}function parseElemSection(e){var t=[];dump([e],"num elements");for(var r=0;r<e;r++){var n=getPosition();var a=readU32();var o=a.value;eatBytes(a.nextIndex);dump([o],"table index");var i=[];parseInstructionBlock(i);var u=readU32();var d=u.value;eatBytes(u.nextIndex);dump([d],"num indices");var s=[];for(var c=0;c<d;c++){var l=readU32();var p=l.value;eatBytes(l.nextIndex);dump([p],"index");s.push(v.indexLiteral(p))}var f=function(){var e=getPosition();return v.withLoc(v.elem(v.indexLiteral(o),i,s),e,n)}();t.push(f)}return t}function parseMemoryType(e){var t=parseLimits();return v.memory(t,v.indexLiteral(e))}function parseTableSection(e){var t=[];dump([e],"num elements");for(var r=0;r<e;r++){var n=parseTableType(r);o.tablesInModule.push(n);t.push(n)}return t}function parseMemorySection(e){var t=[];dump([e],"num elements");for(var r=0;r<e;r++){var n=parseMemoryType(r);o.memoriesInModule.push(n);t.push(n)}return t}function parseStartSection(){var e=getPosition();var t=readU32();var r=t.value;eatBytes(t.nextIndex);dump([r],"index");return function(){var t=getPosition();return v.withLoc(v.start(v.indexLiteral(r)),t,e)}()}function parseDataSection(e){var t=[];dump([e],"num elements");for(var r=0;r<e;r++){var n=readU32();var a=n.value;eatBytes(n.nextIndex);dump([a],"memory index");var o=[];parseInstructionBlock(o);var i=1!==o.filter((function(e){return"end"!==e.id})).length;if(i)throw new s.CompileError("data section offset must be a single instruction");var u=parseVec((function(e){return e}));dump([],"init");t.push(v.data(v.memIndexLiteral(a),o[0],v.byteArray(u)))}return t}function parseSection(e){var r=readByte();eatBytes(1);if(r>=e||e===f.default.sections.custom)e=r+1;else if(r!==f.default.sections.custom)throw new s.CompileError("Unexpected section: "+toHex(r));var n=e;var o=a;var i=getPosition();var u=readU32();var d=u.value;eatBytes(u.nextIndex);var c=function(){var e=getPosition();return v.withLoc(v.numberLiteralFromRaw(d),e,i)}();switch(r){case f.default.sections.type:dumpSep("section Type");dump([r],"section code");dump([d],"section size");var l=getPosition();var p=readU32();var m=p.value;eatBytes(p.nextIndex);var y=v.sectionMetadata("type",o,c,function(){var e=getPosition();return v.withLoc(v.numberLiteralFromRaw(m),e,l)}());var x=parseTypeSection(m);return{nodes:x,metadata:y,nextSectionIndex:n};case f.default.sections.table:dumpSep("section Table");dump([r],"section code");dump([d],"section size");var g=getPosition();var h=readU32();var I=h.value;eatBytes(h.nextIndex);dump([I],"num tables");var w=v.sectionMetadata("table",o,c,function(){var e=getPosition();return v.withLoc(v.numberLiteralFromRaw(I),e,g)}());var b=parseTableSection(I);return{nodes:b,metadata:w,nextSectionIndex:n};case f.default.sections.import:dumpSep("section Import");dump([r],"section code");dump([d],"section size");var B=getPosition();var S=readU32();var M=S.value;eatBytes(S.nextIndex);dump([M],"number of imports");var U=v.sectionMetadata("import",o,c,function(){var e=getPosition();return v.withLoc(v.numberLiteralFromRaw(M),e,B)}());var E=parseImportSection(M);return{nodes:E,metadata:U,nextSectionIndex:n};case f.default.sections.func:dumpSep("section Function");dump([r],"section code");dump([d],"section size");var F=getPosition();var L=readU32();var _=L.value;eatBytes(L.nextIndex);var P=v.sectionMetadata("func",o,c,function(){var e=getPosition();return v.withLoc(v.numberLiteralFromRaw(_),e,F)}());parseFuncSection(_);var N=[];return{nodes:N,metadata:P,nextSectionIndex:n};case f.default.sections.export:dumpSep("section Export");dump([r],"section code");dump([d],"section size");var T=getPosition();var C=readU32();var R=C.value;eatBytes(C.nextIndex);var O=v.sectionMetadata("export",o,c,function(){var e=getPosition();return v.withLoc(v.numberLiteralFromRaw(R),e,T)}());parseExportSection(R);var k=[];return{nodes:k,metadata:O,nextSectionIndex:n};case f.default.sections.code:dumpSep("section Code");dump([r],"section code");dump([d],"section size");var j=getPosition();var A=readU32();var H=A.value;eatBytes(A.nextIndex);var z=v.sectionMetadata("code",o,c,function(){var e=getPosition();return v.withLoc(v.numberLiteralFromRaw(H),e,j)}());if(true===t.ignoreCodeSection){var V=d-A.nextIndex;eatBytes(V)}else parseCodeSection(H);var D=[];return{nodes:D,metadata:z,nextSectionIndex:n};case f.default.sections.start:dumpSep("section Start");dump([r],"section code");dump([d],"section size");var q=v.sectionMetadata("start",o,c);var Y=[parseStartSection()];return{nodes:Y,metadata:q,nextSectionIndex:n};case f.default.sections.element:dumpSep("section Element");dump([r],"section code");dump([d],"section size");var G=getPosition();var W=readU32();var $=W.value;eatBytes(W.nextIndex);var X=v.sectionMetadata("element",o,c,function(){var e=getPosition();return v.withLoc(v.numberLiteralFromRaw($),e,G)}());var J=parseElemSection($);return{nodes:J,metadata:X,nextSectionIndex:n};case f.default.sections.global:dumpSep("section Global");dump([r],"section code");dump([d],"section size");var K=getPosition();var Q=readU32();var Z=Q.value;eatBytes(Q.nextIndex);var ee=v.sectionMetadata("global",o,c,function(){var e=getPosition();return v.withLoc(v.numberLiteralFromRaw(Z),e,K)}());var te=parseGlobalSection(Z);return{nodes:te,metadata:ee,nextSectionIndex:n};case f.default.sections.memory:dumpSep("section Memory");dump([r],"section code");dump([d],"section size");var re=getPosition();var ne=readU32();var ae=ne.value;eatBytes(ne.nextIndex);var oe=v.sectionMetadata("memory",o,c,function(){var e=getPosition();return v.withLoc(v.numberLiteralFromRaw(ae),e,re)}());var ie=parseMemorySection(ae);return{nodes:ie,metadata:oe,nextSectionIndex:n};case f.default.sections.data:dumpSep("section Data");dump([r],"section code");dump([d],"section size");var ue=v.sectionMetadata("data",o,c);var de=getPosition();var se=readU32();var ce=se.value;eatBytes(se.nextIndex);ue.vectorOfSize=function(){var e=getPosition();return v.withLoc(v.numberLiteralFromRaw(ce),e,de)}();if(true===t.ignoreDataSection){var le=d-se.nextIndex;eatBytes(le);dumpSep("ignore data ("+d+" bytes)");return{nodes:[],metadata:ue,nextSectionIndex:n}}var ve=parseDataSection(ce);return{nodes:ve,metadata:ue,nextSectionIndex:n};case f.default.sections.custom:dumpSep("section Custom");dump([r],"section code");dump([d],"section size");var pe=[v.sectionMetadata("custom",o,c)];var fe=readUTF8String();eatBytes(fe.nextIndex);dump([],"section name (".concat(fe.value,")"));var me=d-fe.nextIndex;if("name"===fe.value){var ye=a;try{pe.push.apply(pe,_toConsumableArray(parseNameSection(me)))}catch(e){console.warn('Failed to decode custom "name" section @'.concat(a,"; ignoring (").concat(e.message,")."));eatBytes(a-(ye+me))}}else if("producers"===fe.value){var xe=a;try{pe.push(parseProducersSection())}catch(e){console.warn('Failed to decode custom "producers" section @'.concat(a,"; ignoring (").concat(e.message,")."));eatBytes(a-(xe+me))}}else{eatBytes(me);dumpSep("ignore custom "+JSON.stringify(fe.value)+" section ("+me+" bytes)")}return{nodes:[],metadata:pe,nextSectionIndex:n}}throw new s.CompileError("Unexpected section: "+toHex(r))}parseModuleHeader();parseVersion();var i=[];var u=0;var m={sections:[],functionNames:[],localNames:[],producers:[]};while(a<r.length){var y=parseSection(u),x=y.nodes,g=y.metadata,h=y.nextSectionIndex;i.push.apply(i,_toConsumableArray(x));var I=Array.isArray(g)?g:[g];I.forEach((function(e){"FunctionNameMetadata"===e.type?m.functionNames.push(e):"LocalNameMetadata"===e.type?m.localNames.push(e):"ProducersSectionMetadata"===e.type?m.producers.push(e):m.sections.push(e)}));h&&(u=h)}var w=0;o.functionsInModule.forEach((function(e){var r=e.signature.params;var n=e.signature.result;var a=[];if(true!==e.isExternal){var u=o.elementsInCodeSection[w];if(false===t.ignoreCodeSection){if("undefined"===typeof u)throw new s.CompileError("func "+toHex(w)+" code not found");a=u.code}w++;var d=v.func(e.id,v.signature(r,n),a);true===e.isExternal&&(d.isExternal=e.isExternal);if(false===t.ignoreCodeSection){var c=u.startLoc,l=u.endLoc,p=u.bodySize;d=v.withLoc(d,l,c);d.metadata={bodySize:p}}i.push(d)}}));o.elementsInExportSection.forEach((function(e){null!=e.id&&i.push(v.withLoc(v.moduleExport(e.name,v.moduleExportDescr(e.type,e.id)),e.endLoc,e.startLoc))}));dumpSep("end of program");var b=v.module(null,i,v.moduleMetadata(m.sections,m.functionNames,m.localNames,m.producers));return v.program([b])}var m={};Object.defineProperty(m,"__esModule",{value:true});m.decode=decode$1;var y=_interopRequireWildcard$1(u);var x=_interopRequireWildcard$1(n);function _interopRequireWildcard$1(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var r in e)if(Object.prototype.hasOwnProperty.call(e,r)){var n=Object.defineProperty&&Object.getOwnPropertyDescriptor?Object.getOwnPropertyDescriptor(e,r):{};n.get||n.set?Object.defineProperty(t,r,n):t[r]=e[r]}t.default=e;return t}var g={dump:false,ignoreCodeSection:false,ignoreDataSection:false,ignoreCustomNameSection:false};function restoreFunctionNames(e){var t=[];x.traverse(e,{FunctionNameMetadata:function FunctionNameMetadata(e){var r=e.node;t.push({name:r.value,index:r.index})}});0!==t.length&&x.traverse(e,{Func:function(e){function Func(t){return e.apply(this,arguments)}Func.toString=function(){return e.toString()};return Func}((function(e){var r=e.node;var n=r.name;var a=n.value;var o=Number(a.replace("func_",""));var i=t.find((function(e){return e.index===o}));if(i){var u=n.value;n.value=i.name;n.numeric=u;delete n.raw}})),ModuleExport:function(e){function ModuleExport(t){return e.apply(this,arguments)}ModuleExport.toString=function(){return e.toString()};return ModuleExport}((function(e){var r=e.node;if("Func"===r.descr.exportType){var n=r.descr.id;var a=n.value;var o=t.find((function(e){return e.index===a}));o&&(r.descr.id=x.identifier(o.name))}})),ModuleImport:function(e){function ModuleImport(t){return e.apply(this,arguments)}ModuleImport.toString=function(){return e.toString()};return ModuleImport}((function(e){var r=e.node;if("FuncImportDescr"===r.descr.type){var n=r.descr.id;var a=Number(n.replace("func_",""));var o=t.find((function(e){return e.index===a}));o&&(r.descr.id=x.identifier(o.name))}})),CallInstruction:function(e){function CallInstruction(t){return e.apply(this,arguments)}CallInstruction.toString=function(){return e.toString()};return CallInstruction}((function(e){var r=e.node;var n=r.index.value;var a=t.find((function(e){return e.index===n}));if(a){var o=r.index;r.index=x.identifier(a.name);r.numeric=o;delete r.raw}}))})}function restoreLocalNames(e){var t=[];x.traverse(e,{LocalNameMetadata:function LocalNameMetadata(e){var r=e.node;t.push({name:r.value,localIndex:r.localIndex,functionIndex:r.functionIndex})}});0!==t.length&&x.traverse(e,{Func:function(e){function Func(t){return e.apply(this,arguments)}Func.toString=function(){return e.toString()};return Func}((function(e){var r=e.node;var n=r.signature;if("Signature"===n.type){var a=r.name;var o=a.value;var i=Number(o.replace("func_",""));n.params.forEach((function(e,r){var n=t.find((function(e){return e.localIndex===r&&e.functionIndex===i}));n&&""!==n.name&&(e.id=n.name)}))}}))})}function restoreModuleName(e){x.traverse(e,{ModuleNameMetadata:function(e){function ModuleNameMetadata(t){return e.apply(this,arguments)}ModuleNameMetadata.toString=function(){return e.toString()};return ModuleNameMetadata}((function(t){x.traverse(e,{Module:function(e){function Module(t){return e.apply(this,arguments)}Module.toString=function(){return e.toString()};return Module}((function(e){var r=e.node;var n=t.node.value;""===n&&(n=null);r.id=n}))})}))})}function decode$1(e,t){var r=Object.assign({},g,t);var n=y.decode(e,r);if(false===r.ignoreCustomNameSection){restoreFunctionNames(n);restoreLocalNames(n);restoreModuleName(n)}return n}const h=m.__esModule;const I=m.decode;export default m;export{h as __esModule,I as decode};

