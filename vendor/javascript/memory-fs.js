import e from"./normalize.js";import r from"errno";import t from"readable-stream";import i from"./join.js";import o from"process";import n from"buffer";var s="undefined"!==typeof globalThis?globalThis:"undefined"!==typeof self?self:global;var a={};var y=n.Buffer;var l=o;var c=e;var m=r;var f=t;var h=f.Readable;var p=f.Writable;function MemoryFileSystemError(e,r){Error.call(this||s);Error.captureStackTrace&&Error.captureStackTrace(this||s,arguments.callee);(this||s).code=e.code;(this||s).errno=e.errno;(this||s).message=e.description;(this||s).path=r}MemoryFileSystemError.prototype=new Error;function MemoryFileSystem(e){(this||s).data=e||{}}a=MemoryFileSystem;function isDir(e){return"object"===typeof e&&true===e[""]}function isFile(e){return"object"===typeof e&&!e[""]}function pathToArray(e){e=c(e);var r=/^\//.test(e);if(r){e=e.replace(/\/+/g,"/");e=e.substr(1).split("/")}else{if(!/^[A-Za-z]:/.test(e))throw new MemoryFileSystemError(m.code.EINVAL,e);e=e.replace(/[\\\/]+/g,"\\");e=e.split(/[\\\/]/);e[0]=e[0].toUpperCase()}e[e.length-1]||e.pop();return e}function trueFn(){return true}function falseFn(){return false}MemoryFileSystem.prototype.meta=function(e){var r=pathToArray(e);var t=(this||s).data;for(var i=0;i<r.length-1;i++){if(!isDir(t[r[i]]))return;t=t[r[i]]}return t[r[i]]};MemoryFileSystem.prototype.existsSync=function(e){return!!this.meta(e)};MemoryFileSystem.prototype.statSync=function(e){var r=this.meta(e);if("/"===e||isDir(r))return{isFile:falseFn,isDirectory:trueFn,isBlockDevice:falseFn,isCharacterDevice:falseFn,isSymbolicLink:falseFn,isFIFO:falseFn,isSocket:falseFn};if(isFile(r))return{isFile:trueFn,isDirectory:falseFn,isBlockDevice:falseFn,isCharacterDevice:falseFn,isSymbolicLink:falseFn,isFIFO:falseFn,isSocket:falseFn};throw new MemoryFileSystemError(m.code.ENOENT,e)};MemoryFileSystem.prototype.readFileSync=function(e,r){var t=pathToArray(e);var i=(this||s).data;for(var o=0;o<t.length-1;o++){if(!isDir(i[t[o]]))throw new MemoryFileSystemError(m.code.ENOENT,e);i=i[t[o]]}if(!isFile(i[t[o]]))throw isDir(i[t[o]])?new MemoryFileSystemError(m.code.EISDIR,e):new MemoryFileSystemError(m.code.ENOENT,e);i=i[t[o]];return r?i.toString(r):i};MemoryFileSystem.prototype.readdirSync=function(e){if("/"===e)return Object.keys((this||s).data).filter(Boolean);var r=pathToArray(e);var t=(this||s).data;for(var i=0;i<r.length-1;i++){if(!isDir(t[r[i]]))throw new MemoryFileSystemError(m.code.ENOENT,e);t=t[r[i]]}if(!isDir(t[r[i]]))throw isFile(t[r[i]])?new MemoryFileSystemError(m.code.ENOTDIR,e):new MemoryFileSystemError(m.code.ENOENT,e);return Object.keys(t[r[i]]).filter(Boolean)};MemoryFileSystem.prototype.mkdirpSync=function(e){var r=pathToArray(e);if(0!==r.length){var t=(this||s).data;for(var i=0;i<r.length;i++){if(isFile(t[r[i]]))throw new MemoryFileSystemError(m.code.ENOTDIR,e);isDir(t[r[i]])||(t[r[i]]={"":true});t=t[r[i]]}}};MemoryFileSystem.prototype.mkdirSync=function(e){var r=pathToArray(e);if(0!==r.length){var t=(this||s).data;for(var i=0;i<r.length-1;i++){if(!isDir(t[r[i]]))throw new MemoryFileSystemError(m.code.ENOENT,e);t=t[r[i]]}if(isDir(t[r[i]]))throw new MemoryFileSystemError(m.code.EEXIST,e);if(isFile(t[r[i]]))throw new MemoryFileSystemError(m.code.ENOTDIR,e);t[r[i]]={"":true}}};MemoryFileSystem.prototype._remove=function(e,r,t){var i=pathToArray(e);if(0===i.length)throw new MemoryFileSystemError(m.code.EPERM,e);var o=(this||s).data;for(var n=0;n<i.length-1;n++){if(!isDir(o[i[n]]))throw new MemoryFileSystemError(m.code.ENOENT,e);o=o[i[n]]}if(!t(o[i[n]]))throw new MemoryFileSystemError(m.code.ENOENT,e);delete o[i[n]]};MemoryFileSystem.prototype.rmdirSync=function(e){return this._remove(e,"Directory",isDir)};MemoryFileSystem.prototype.unlinkSync=function(e){return this._remove(e,"File",isFile)};MemoryFileSystem.prototype.readlinkSync=function(e){throw new MemoryFileSystemError(m.code.ENOSYS,e)};MemoryFileSystem.prototype.writeFileSync=function(e,r,t){if(!r&&!t)throw new Error("No content");var i=pathToArray(e);if(0===i.length)throw new MemoryFileSystemError(m.code.EISDIR,e);var o=(this||s).data;for(var n=0;n<i.length-1;n++){if(!isDir(o[i[n]]))throw new MemoryFileSystemError(m.code.ENOENT,e);o=o[i[n]]}if(isDir(o[i[n]]))throw new MemoryFileSystemError(m.code.EISDIR,e);o[i[n]]=t||"string"===typeof r?new y(r,t):r};MemoryFileSystem.prototype.join=i;MemoryFileSystem.prototype.pathToArray=pathToArray;MemoryFileSystem.prototype.normalize=c;MemoryFileSystem.prototype.createReadStream=function(e,r){var t=new h;var i=false;var o;try{o=this.readFileSync(e)}catch(e){t._read=function(){if(!i){i=true;this.emit("error",e);this.push(null)}};return t}r=r||{};r.start=r.start||0;r.end=r.end||o.length;t._read=function(){if(!i){i=true;this.push(o.slice(r.start,r.end));this.push(null)}};return t};MemoryFileSystem.prototype.createWriteStream=function(e,r){var t=new p,i=this||s;try{this.writeFileSync(e,new y(0))}catch(e){t.once("prefinish",(function(){t.emit("error",e)}));return t}var o=[],n=0;t._write=function(r,t,s){o.push(r);n+=r.length;i.writeFile(e,y.concat(o,n),s)};return t};["stat","readdir","mkdirp","rmdir","unlink","readlink"].forEach((function(e){MemoryFileSystem.prototype[e]=function(r,t){try{var i=this[e+"Sync"](r)}catch(e){l.nextTick((function(){t(e)}));return}l.nextTick((function(){t(null,i)}))}}));["mkdir","readFile"].forEach((function(e){MemoryFileSystem.prototype[e]=function(r,t,i){if(!i){i=t;t=void 0}try{var o=this[e+"Sync"](r,t)}catch(e){l.nextTick((function(){i(e)}));return}l.nextTick((function(){i(null,o)}))}}));MemoryFileSystem.prototype.exists=function(e,r){return r(this.existsSync(e))};MemoryFileSystem.prototype.writeFile=function(e,r,t,i){if(!i){i=t;t=void 0}try{this.writeFileSync(e,r,t)}catch(e){return i(e)}return i()};var u=a;export default u;

