import e from"fs";import r from"process";import t from"buffer";var n={};class LoadingLoaderError extends Error{constructor(e){super(e);this.name="LoaderRunnerError";Error.captureStackTrace(this,this.constructor)}}n=LoadingLoaderError;var o=n;var a={};function _nullRequire(e){var r=new Error("Cannot find module '"+e+"'");r.code="MODULE_NOT_FOUND";throw r}var u=r;var i=o;a=function loadLoader(e,r){if("object"===typeof System&&"function"===typeof System.import)System.import(e.path).catch(r).then((function(t){e.normal="function"===typeof t?t:t.default;e.pitch=t.pitch;e.raw=t.raw;if("function"!==typeof e.normal&&"function"!==typeof e.pitch)return r(new i("Module '"+e.path+"' is not a loader (must have normal or pitch function)"));r()}));else{try{var t=_nullRequire(e.path)}catch(t){if(t instanceof Error&&"EMFILE"===t.code){var n=loadLoader.bind(null,e,r);return"function"===typeof u.nextTick,u.nextTick(n)}return r(t)}if("function"!==typeof t&&"object"!==typeof t)return r(new i("Module '"+e.path+"' is not a loader (export function or es6 module)"));e.normal="function"===typeof t?t:t.default;e.pitch=t.pitch;e.raw=t.raw;if("function"!==typeof e.normal&&"function"!==typeof e.pitch)return r(new i("Module '"+e.path+"' is not a loader (must have normal or pitch function)"));r()}};var c=a;var s={};var l=t.Buffer;var d=e;var f=d.readFile.bind(d);var p=c;function utf8BufferToString(e){var r=e.toString("utf-8");return 65279===r.charCodeAt(0)?r.substr(1):r}function splitQuery(e){var r=e.indexOf("?");return r<0?[e,""]:[e.substr(0,r),e.substr(r)]}function dirname(e){if("/"===e)return"/";var r=e.lastIndexOf("/");var t=e.lastIndexOf("\\");var n=e.indexOf("/");var o=e.indexOf("\\");var a=r>t?r:t;var u=r>t?n:o;return a<0?e:a===u?e.substr(0,a+1):e.substr(0,a)}function createLoaderObject(e){var r={path:null,query:null,options:null,ident:null,normal:null,pitch:null,raw:null,data:null,pitchExecuted:false,normalExecuted:false};Object.defineProperty(r,"request",{enumerable:true,get:function(){return r.path+r.query},set:function(e){if("string"===typeof e){var t=splitQuery(e);r.path=t[0];r.query=t[1];r.options=void 0;r.ident=void 0}else{if(!e.loader)throw new Error("request should be a string or object with loader and object ("+JSON.stringify(e)+")");r.path=e.loader;r.options=e.options;r.ident=e.ident;null===r.options||void 0===r.options?r.query="":"string"===typeof r.options?r.query="?"+r.options:r.ident?r.query="??"+r.ident:"object"===typeof r.options&&r.options.ident?r.query="??"+r.options.ident:r.query="?"+JSON.stringify(r.options)}}});r.request=e;Object.preventExtensions&&Object.preventExtensions(r);return r}function runSyncOrAsync(e,r,t,n){var o=true;var a=false;var u=false;var i=false;r.async=function async(){if(a){if(i)return;throw new Error("async(): The callback was already called.")}o=false;return c};var c=r.callback=function(){if(a){if(i)return;throw new Error("callback(): The callback was already called.")}a=true;o=false;try{n.apply(null,arguments)}catch(e){u=true;throw e}};try{var s=function LOADER_EXECUTION(){return e.apply(r,t)}();if(o){a=true;return void 0===s?n():s&&"object"===typeof s&&"function"===typeof s.then?s.then((function(e){n(null,e)}),n):n(null,s)}}catch(e){if(u)throw e;if(a){"object"===typeof e&&e.stack?console.error(e.stack):console.error(e);return}a=true;i=true;n(e)}}function convertArgs(e,r){!r&&l.isBuffer(e[0])?e[0]=utf8BufferToString(e[0]):r&&"string"===typeof e[0]&&(e[0]=new l(e[0],"utf-8"))}function iteratePitchingLoaders(e,r,t){if(r.loaderIndex>=r.loaders.length)return processResource(e,r,t);var n=r.loaders[r.loaderIndex];if(n.pitchExecuted){r.loaderIndex++;return iteratePitchingLoaders(e,r,t)}p(n,(function(o){if(o){r.cacheable(false);return t(o)}var a=n.pitch;n.pitchExecuted=true;if(!a)return iteratePitchingLoaders(e,r,t);runSyncOrAsync(a,r,[r.remainingRequest,r.previousRequest,n.data={}],(function(n){if(n)return t(n);var o=Array.prototype.slice.call(arguments,1);if(o.length>0){r.loaderIndex--;iterateNormalLoaders(e,r,o,t)}else iteratePitchingLoaders(e,r,t)}))}))}function processResource(e,r,t){r.loaderIndex=r.loaders.length-1;var n=r.resourcePath;if(n){r.addDependency(n);e.readResource(n,(function(n,o){if(n)return t(n);e.resourceBuffer=o;iterateNormalLoaders(e,r,[o],t)}))}else iterateNormalLoaders(e,r,[null],t)}function iterateNormalLoaders(e,r,t,n){if(r.loaderIndex<0)return n(null,t);var o=r.loaders[r.loaderIndex];if(o.normalExecuted){r.loaderIndex--;return iterateNormalLoaders(e,r,t,n)}var a=o.normal;o.normalExecuted=true;if(!a)return iterateNormalLoaders(e,r,t,n);convertArgs(t,o.raw);runSyncOrAsync(a,r,t,(function(t){if(t)return n(t);var o=Array.prototype.slice.call(arguments,1);iterateNormalLoaders(e,r,o,n)}))}s.getContext=function getContext(e){var r=splitQuery(e);return dirname(r[0])};s.runLoaders=function runLoaders(e,r){var t=e.resource||"";var n=e.loaders||[];var o=e.context||{};var a=e.readResource||f;var u=t&&splitQuery(t);var i=u?u[0]:void 0;var c=u?u[1]:void 0;var s=i?dirname(i):null;var l=true;var d=[];var p=[];n=n.map(createLoaderObject);o.context=s;o.loaderIndex=0;o.loaders=n;o.resourcePath=i;o.resourceQuery=c;o.async=null;o.callback=null;o.cacheable=function cacheable(e){false===e&&(l=false)};o.dependency=o.addDependency=function addDependency(e){d.push(e)};o.addContextDependency=function addContextDependency(e){p.push(e)};o.getDependencies=function getDependencies(){return d.slice()};o.getContextDependencies=function getContextDependencies(){return p.slice()};o.clearDependencies=function clearDependencies(){d.length=0;p.length=0;l=true};Object.defineProperty(o,"resource",{enumerable:true,get:function(){if(void 0!==o.resourcePath)return o.resourcePath+o.resourceQuery},set:function(e){var r=e&&splitQuery(e);o.resourcePath=r?r[0]:void 0;o.resourceQuery=r?r[1]:void 0}});Object.defineProperty(o,"request",{enumerable:true,get:function(){return o.loaders.map((function(e){return e.request})).concat(o.resource||"").join("!")}});Object.defineProperty(o,"remainingRequest",{enumerable:true,get:function(){return o.loaderIndex>=o.loaders.length-1&&!o.resource?"":o.loaders.slice(o.loaderIndex+1).map((function(e){return e.request})).concat(o.resource||"").join("!")}});Object.defineProperty(o,"currentRequest",{enumerable:true,get:function(){return o.loaders.slice(o.loaderIndex).map((function(e){return e.request})).concat(o.resource||"").join("!")}});Object.defineProperty(o,"previousRequest",{enumerable:true,get:function(){return o.loaders.slice(0,o.loaderIndex).map((function(e){return e.request})).join("!")}});Object.defineProperty(o,"query",{enumerable:true,get:function(){var e=o.loaders[o.loaderIndex];return e.options&&"object"===typeof e.options?e.options:e.query}});Object.defineProperty(o,"data",{enumerable:true,get:function(){return o.loaders[o.loaderIndex].data}});Object.preventExtensions&&Object.preventExtensions(o);var y={resourceBuffer:null,readResource:a};iteratePitchingLoaders(y,o,(function(e,t){if(e)return r(e,{cacheable:l,fileDependencies:d,contextDependencies:p});r(null,{result:t,resourceBuffer:y.resourceBuffer,cacheable:l,fileDependencies:d,contextDependencies:p})}))};const y=s.getContext,v=s.runLoaders;export default s;export{y as getContext,v as runLoaders};

