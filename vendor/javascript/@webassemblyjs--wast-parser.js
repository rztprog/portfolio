import e from"@webassemblyjs/helper-code-frame";import n from"@webassemblyjs/ast";import"@xtuc/long";import"@webassemblyjs/floating-point-hex-parser";import"@webassemblyjs/helper-api-error";import r from"./number-literals.js";import t from"@webassemblyjs/helper-fsm";var o={};Object.defineProperty(o,"__esModule",{value:true});o.parseString=parseString;var a=[0,7,8,9,10,11,12,13,26,27,127];function decodeControlCharacter(e){switch(e){case"t":return 9;case"n":return 10;case"r":return 13;case'"':return 34;case"â€²":return 39;case"\\":return 92}return-1}var i=92;var s=34;function parseString(e){var n=[];var r=0;while(r<e.length){var t=e.charCodeAt(r);if(-1!==a.indexOf(t))throw new Error("ASCII control characters are not permitted within string literals");if(t===s)throw new Error("quotes are not permitted within string literals");if(t===i){var o=e.substr(r+1,1);var k=decodeControlCharacter(o);if(-1!==k){n.push(k);r+=2}else{var l=e.substr(r+1,2);if(!/^[0-9A-F]{2}$/i.test(l))throw new Error("invalid character encoding");n.push(parseInt(l,16));r+=3}}else{n.push(t);r++}}return n}var k={};Object.defineProperty(k,"__esModule",{value:true});k.tokenize=tokenize;k.tokens=k.keywords=void 0;var l=t;var p=e;function getCodeFrame(e,n,r){var t={start:{line:n,column:r}};return"\n"+(0,p.codeFrameFromSource)(e,t)+"\n"}var u=/\s/;var c=/\(|\)/;var d=/[a-z0-9_/]/i;var f=/[a-z0-9!#$%&*+./:<=>?@\\[\]^_`|~-]/i;var y=["i32","i64","f32","f64"];var T=/[0-9|.|_]/;var v=/nan|inf/;function isNewLine(e){return 10===e.charCodeAt(0)||13===e.charCodeAt(0)}function Token(e,n,r,t){var o=arguments.length>4&&void 0!==arguments[4]?arguments[4]:{};var a={type:e,value:n,loc:{start:r,end:t}};Object.keys(o).length>0&&(a["opts"]=o);return a}var m={openParen:"openParen",closeParen:"closeParen",number:"number",string:"string",name:"name",identifier:"identifier",valtype:"valtype",dot:"dot",comment:"comment",equal:"equal",keyword:"keyword"};var h={module:"module",func:"func",param:"param",result:"result",export:"export",loop:"loop",block:"block",if:"if",then:"then",else:"else",call:"call",call_indirect:"call_indirect",import:"import",memory:"memory",table:"table",global:"global",anyfunc:"anyfunc",mut:"mut",data:"data",type:"type",elem:"elem",start:"start",offset:"offset"};k.keywords=h;var w="_";var g=new l.FSM({START:[(0,l.makeTransition)(/-|\+/,"AFTER_SIGN"),(0,l.makeTransition)(/nan:0x/,"NAN_HEX",{n:6}),(0,l.makeTransition)(/nan|inf/,"STOP",{n:3}),(0,l.makeTransition)(/0x/,"HEX",{n:2}),(0,l.makeTransition)(/[0-9]/,"DEC"),(0,l.makeTransition)(/\./,"DEC_FRAC")],AFTER_SIGN:[(0,l.makeTransition)(/nan:0x/,"NAN_HEX",{n:6}),(0,l.makeTransition)(/nan|inf/,"STOP",{n:3}),(0,l.makeTransition)(/0x/,"HEX",{n:2}),(0,l.makeTransition)(/[0-9]/,"DEC"),(0,l.makeTransition)(/\./,"DEC_FRAC")],DEC_FRAC:[(0,l.makeTransition)(/[0-9]/,"DEC_FRAC",{allowedSeparator:w}),(0,l.makeTransition)(/e|E/,"DEC_SIGNED_EXP")],DEC:[(0,l.makeTransition)(/[0-9]/,"DEC",{allowedSeparator:w}),(0,l.makeTransition)(/\./,"DEC_FRAC"),(0,l.makeTransition)(/e|E/,"DEC_SIGNED_EXP")],DEC_SIGNED_EXP:[(0,l.makeTransition)(/\+|-/,"DEC_EXP"),(0,l.makeTransition)(/[0-9]/,"DEC_EXP")],DEC_EXP:[(0,l.makeTransition)(/[0-9]/,"DEC_EXP",{allowedSeparator:w})],HEX:[(0,l.makeTransition)(/[0-9|A-F|a-f]/,"HEX",{allowedSeparator:w}),(0,l.makeTransition)(/\./,"HEX_FRAC"),(0,l.makeTransition)(/p|P/,"HEX_SIGNED_EXP")],HEX_FRAC:[(0,l.makeTransition)(/[0-9|A-F|a-f]/,"HEX_FRAC",{allowedSeparator:w}),(0,l.makeTransition)(/p|P|/,"HEX_SIGNED_EXP")],HEX_SIGNED_EXP:[(0,l.makeTransition)(/[0-9|+|-]/,"HEX_EXP")],HEX_EXP:[(0,l.makeTransition)(/[0-9]/,"HEX_EXP",{allowedSeparator:w})],NAN_HEX:[(0,l.makeTransition)(/[0-9|A-F|a-f]/,"NAN_HEX",{allowedSeparator:w})],STOP:[]},"START","STOP");function tokenize(e){var n=0;var r=e[n];var t=1;var o=1;var a=[];function pushToken(e){return function(n){var r=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};var i=r.startColumn||t-String(n).length;delete r.startColumn;var s=r.endColumn||i+String(n).length-1;delete r.endColumn;var k={line:o,column:i};var l={line:o,column:s};a.push(Token(e,n,k,l,r))}}var i=pushToken(m.closeParen);var s=pushToken(m.openParen);var k=pushToken(m.number);var l=pushToken(m.valtype);var p=pushToken(m.name);var w=pushToken(m.identifier);var E=pushToken(m.keyword);var P=pushToken(m.dot);var b=pushToken(m.string);var C=pushToken(m.comment);var F=pushToken(m.equal);function lookahead(){var r=arguments.length>0&&void 0!==arguments[0]?arguments[0]:1;var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:1;return e.substring(n+t,n+t+r).toLowerCase()}function eatCharacter(){var o=arguments.length>0&&void 0!==arguments[0]?arguments[0]:1;t+=o;n+=o;r=e[n]}while(n<e.length)if(";"!==r||";"!==lookahead())if("("!==r||";"!==lookahead())if("("!==r)if("="!==r)if(")"!==r)if(isNewLine(r)){o++;eatCharacter();t=0}else if(u.test(r))eatCharacter();else if("$"!==r)if(T.test(r)||v.test(lookahead(3,0))||"-"===r||"+"===r){var O=t;var x=g.run(e.slice(n));if(""===x)throw new Error(getCodeFrame(e,o,t)+"Unexpected character "+JSON.stringify(r));k(x,{startColumn:O});eatCharacter(x.length);if(r&&!c.test(r)&&!u.test(r))throw new Error(getCodeFrame(e,o,t)+"Unexpected character "+JSON.stringify(r))}else if('"'!==r){if(!d.test(r))throw new Error(getCodeFrame(e,o,t)+"Unexpected character "+JSON.stringify(r));var S="";var A=t;while(r&&d.test(r)){S+=r;eatCharacter()}if("."===r){var _=t;-1!==y.indexOf(S)?l(S,{startColumn:A}):p(S);eatCharacter();S="";var I=t;while(d.test(r)){S+=r;eatCharacter()}P(".",{startColumn:_});p(S,{startColumn:I});continue}if("string"===typeof h[S]){E(S,{startColumn:A});continue}if(-1!==y.indexOf(S)){l(S,{startColumn:A});continue}p(S,{startColumn:A})}else{var L=t;var R="";eatCharacter();while('"'!==r){if(isNewLine(r))throw new Error(getCodeFrame(e,o,t)+"Unexpected character "+JSON.stringify(r));R+=r;eatCharacter()}eatCharacter();var K=t;b(R,{startColumn:L,endColumn:K})}else{var D=t;eatCharacter();var X="";while(f.test(r)){X+=r;eatCharacter()}var j=t;w(X,{startColumn:D,endColumn:j})}else{i(r);eatCharacter()}else{F(r);eatCharacter()}else{s(r);eatCharacter()}else{var N=t;eatCharacter(2);var U="";while(true){r=e[n];if(";"===r&&")"===lookahead()){eatCharacter(2);break}U+=r;eatCharacter();if(isNewLine(r)){o++;t=0}}var M=t;C(U,{type:"block",startColumn:N,endColumn:M})}else{var H=t;eatCharacter(2);var q="";while(!isNewLine(r)){q+=r;eatCharacter();if(void 0===r)break}var G=t;C(q,{type:"leading",startColumn:H,endColumn:G})}return a}var E=m;k.tokens=E;var P={};Object.defineProperty(P,"__esModule",{value:true});P.parse=parse;var b=e;var C=_interopRequireWildcard(n);var F=r;var O=o;var x=k;function _interopRequireWildcard(e){if(e&&e.__esModule)return e;var n={};if(null!=e)for(var r in e)if(Object.prototype.hasOwnProperty.call(e,r)){var t=Object.defineProperty&&Object.getOwnPropertyDescriptor?Object.getOwnPropertyDescriptor(e,r):{};t.get||t.set?Object.defineProperty(n,r,t):n[r]=e[r]}n.default=e;return n}function _typeof(e){_typeof="function"===typeof Symbol&&"symbol"===typeof Symbol.iterator?function _typeof(e){return typeof e}:function _typeof(e){return e&&"function"===typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e};return _typeof(e)}function _toConsumableArray(e){if(Array.isArray(e)){for(var n=0,r=new Array(e.length);n<e.length;n++)r[n]=e[n];return r}return Array.from(e)}function hasPlugin(e){if("wast"!==e)throw new Error("unknow plugin");return true}function isKeyword(e,n){return e.type===x.tokens.keyword&&e.value===n}function tokenToString(e){return"keyword"===e.type?"keyword (".concat(e.value,")"):e.type}function identifierFromToken(e){var n=e.loc,r=n.end,t=n.start;return C.withLoc(C.identifier(e.value),r,t)}function parse(e,n){var r=0;var t=C.getUniqueNameGenerator();var o={registredExportedElements:[]};function walk(){var a=e[r];function eatToken(){a=e[++r]}function getEndLoc(){var n=a;if("undefined"===typeof n){var r=e[e.length-1];n=r}return n.loc.end}function getStartLoc(){return a.loc.start}function eatTokenOfType(e){if(a.type!==e)throw new Error("\n"+(0,b.codeFrameFromSource)(n,a.loc)+"Assertion error: expected token of type "+e+", given "+tokenToString(a));eatToken()}function parseExportIndex(e){if(e.type===x.tokens.identifier){var r=identifierFromToken(e);eatToken();return r}if(e.type===x.tokens.number){var t=C.numberLiteralFromRaw(e.value);eatToken();return t}throw function(){return new Error("\n"+(0,b.codeFrameFromSource)(n,e.loc)+"\n"+"unknown export index"+", given "+tokenToString(e))}()}function lookaheadAndCheck(){var n=arguments.length;for(var t=0;t<n;t++){var o=e[r+t];var a=t<0||arguments.length<=t?void 0:arguments[t];if("keyword"===o.type){if(false===isKeyword(o,a))return false}else if(a!==o.type)return false}return true}function maybeIgnoreComment(){if("undefined"!==typeof a)while(a.type===x.tokens.comment){eatToken();if("undefined"===typeof a)break}}function parseMemory(){var e=C.identifier(t("memory"));var r=C.limit(0);if(a.type===x.tokens.string||a.type===x.tokens.identifier){e=C.identifier(a.value);eatToken()}else e=C.withRaw(e,"");if(lookaheadAndCheck(x.tokens.openParen,x.keywords.data)){eatToken();eatToken();var i=a.value;eatTokenOfType(x.tokens.string);r=C.limit(i.length);eatTokenOfType(x.tokens.closeParen)}if(lookaheadAndCheck(x.tokens.openParen,x.keywords.export)){eatToken();eatToken();if(a.type!==x.tokens.string)throw function(){return new Error("\n"+(0,b.codeFrameFromSource)(n,a.loc)+"\n"+"Expected string in export"+", given "+tokenToString(a))}();var s=a.value;eatToken();o.registredExportedElements.push({exportType:"Memory",name:s,id:e});eatTokenOfType(x.tokens.closeParen)}if(a.type===x.tokens.number){r=C.limit((0,F.parse32I)(a.value));eatToken();if(a.type===x.tokens.number){r.max=(0,F.parse32I)(a.value);eatToken()}}return C.memory(r,e)}function parseData(){var e=0;if(a.type===x.tokens.number){e=a.value;eatTokenOfType(x.tokens.number)}eatTokenOfType(x.tokens.openParen);var n;if(a.type===x.tokens.valtype){eatTokenOfType(x.tokens.valtype);eatTokenOfType(x.tokens.dot);if("const"!==a.value)throw new Error("constant expression required");eatTokenOfType(x.tokens.name);var r=C.numberLiteralFromRaw(a.value,"i32");n=C.objectInstruction("const","i32",[r]);eatToken();eatTokenOfType(x.tokens.closeParen)}else{eatTokenOfType(x.tokens.name);var t=C.numberLiteralFromRaw(a.value,"i32");n=C.instruction("get_global",[t]);eatToken();eatTokenOfType(x.tokens.closeParen)}var o=(0,O.parseString)(a.value);eatToken();return C.data(C.memIndexLiteral(e),n,C.byteArray(o))}function parseTable(){var e=C.identifier(t("table"));var r=C.limit(0);var i=[];var s="anyfunc";if(a.type===x.tokens.string||a.type===x.tokens.identifier){e=identifierFromToken(a);eatToken()}else e=C.withRaw(e,"");while(a.type!==x.tokens.closeParen)if(lookaheadAndCheck(x.tokens.openParen,x.keywords.elem)){eatToken();eatToken();while(a.type===x.tokens.identifier){i.push(C.identifier(a.value));eatToken()}eatTokenOfType(x.tokens.closeParen)}else if(lookaheadAndCheck(x.tokens.openParen,x.keywords.export)){eatToken();eatToken();if(a.type!==x.tokens.string)throw function(){return new Error("\n"+(0,b.codeFrameFromSource)(n,a.loc)+"\n"+"Expected string in export"+", given "+tokenToString(a))}();var k=a.value;eatToken();o.registredExportedElements.push({exportType:"Table",name:k,id:e});eatTokenOfType(x.tokens.closeParen)}else if(isKeyword(a,x.keywords.anyfunc))eatToken();else{if(a.type!==x.tokens.number)throw function(){return new Error("\n"+(0,b.codeFrameFromSource)(n,a.loc)+"\n"+"Unexpected token"+", given "+tokenToString(a))}();var l=parseInt(a.value);eatToken();if(a.type===x.tokens.number){var p=parseInt(a.value);eatToken();r=C.limit(l,p)}else r=C.limit(l);eatToken()}return i.length>0?C.table(s,r,e,i):C.table(s,r,e)}function parseImport(){if(a.type!==x.tokens.string)throw new Error("Expected a string, "+a.type+" given.");var e=a.value;eatToken();if(a.type!==x.tokens.string)throw new Error("Expected a string, "+a.type+" given.");var r=a.value;eatToken();eatTokenOfType(x.tokens.openParen);var o;if(isKeyword(a,x.keywords.func)){eatToken();var i=[];var s=[];var k;var l=C.identifier(t("func"));if(a.type===x.tokens.identifier){l=identifierFromToken(a);eatToken()}while(a.type===x.tokens.openParen){eatToken();if(true===lookaheadAndCheck(x.keywords.type)){eatToken();k=parseTypeReference()}else if(true===lookaheadAndCheck(x.keywords.param)){eatToken();i.push.apply(i,_toConsumableArray(parseFuncParam()))}else{if(true!==lookaheadAndCheck(x.keywords.result))throw function(){return new Error("\n"+(0,b.codeFrameFromSource)(n,a.loc)+"\n"+"Unexpected token in import of type"+", given "+tokenToString(a))}();eatToken();s.push.apply(s,_toConsumableArray(parseFuncResult()))}eatTokenOfType(x.tokens.closeParen)}if("undefined"===typeof l)throw new Error("Imported function must have a name");o=C.funcImportDescr(l,void 0!==k?k:C.signature(i,s))}else if(isKeyword(a,x.keywords.global)){eatToken();if(a.type===x.tokens.openParen){eatToken();eatTokenOfType(x.tokens.keyword);var p=a.value;eatToken();o=C.globalType(p,"var");eatTokenOfType(x.tokens.closeParen)}else{var u=a.value;eatTokenOfType(x.tokens.valtype);o=C.globalType(u,"const")}}else if(true===isKeyword(a,x.keywords.memory)){eatToken();o=parseMemory()}else{if(true!==isKeyword(a,x.keywords.table))throw new Error("Unsupported import type: "+tokenToString(a));eatToken();o=parseTable()}eatTokenOfType(x.tokens.closeParen);return C.moduleImport(e,r,o)}function parseBlock(){var e=C.identifier(t("block"));var r=null;var o=[];if(a.type===x.tokens.identifier){e=identifierFromToken(a);eatToken()}else e=C.withRaw(e,"");while(a.type===x.tokens.openParen){eatToken();if(true===lookaheadAndCheck(x.keywords.result)){eatToken();r=a.value;eatToken()}else{if(true!==lookaheadAndCheck(x.tokens.name)&&true!==lookaheadAndCheck(x.tokens.valtype)&&"keyword"!==a.type)throw function(){return new Error("\n"+(0,b.codeFrameFromSource)(n,a.loc)+"\n"+"Unexpected token in block body of type"+", given "+tokenToString(a))}();o.push(parseFuncInstr())}maybeIgnoreComment();eatTokenOfType(x.tokens.closeParen)}return C.blockInstruction(e,o,r)}function parseIf(){var e=null;var r=C.identifier(t("if"));var o=[];var i=[];var s=[];if(a.type===x.tokens.identifier){r=identifierFromToken(a);eatToken()}else r=C.withRaw(r,"");while(a.type===x.tokens.openParen){eatToken();if(true!==isKeyword(a,x.keywords.result))if(true!==isKeyword(a,x.keywords.then))if(isKeyword(a,x.keywords.else)){eatToken();while(a.type===x.tokens.openParen){eatToken();if(true!==lookaheadAndCheck(x.tokens.name)&&true!==lookaheadAndCheck(x.tokens.valtype)&&"keyword"!==a.type)throw function(){return new Error("\n"+(0,b.codeFrameFromSource)(n,a.loc)+"\n"+"Unexpected token in alternate body of type"+", given "+tokenToString(a))}();s.push(parseFuncInstr());eatTokenOfType(x.tokens.closeParen)}eatTokenOfType(x.tokens.closeParen)}else{if(true!==lookaheadAndCheck(x.tokens.name)&&true!==lookaheadAndCheck(x.tokens.valtype)&&"keyword"!==a.type)throw function(){return new Error("\n"+(0,b.codeFrameFromSource)(n,a.loc)+"\n"+"Unexpected token in if body"+", given "+tokenToString(a))}();o.push(parseFuncInstr());eatTokenOfType(x.tokens.closeParen)}else{eatToken();while(a.type===x.tokens.openParen){eatToken();if(true!==lookaheadAndCheck(x.tokens.name)&&true!==lookaheadAndCheck(x.tokens.valtype)&&"keyword"!==a.type)throw function(){return new Error("\n"+(0,b.codeFrameFromSource)(n,a.loc)+"\n"+"Unexpected token in consequent body of type"+", given "+tokenToString(a))}();i.push(parseFuncInstr());eatTokenOfType(x.tokens.closeParen)}eatTokenOfType(x.tokens.closeParen)}else{eatToken();e=a.value;eatTokenOfType(x.tokens.valtype);eatTokenOfType(x.tokens.closeParen)}}return C.ifInstruction(r,o,e,i,s)}function parseLoop(){var e=C.identifier(t("loop"));var r;var o=[];if(a.type===x.tokens.identifier){e=identifierFromToken(a);eatToken()}else e=C.withRaw(e,"");while(a.type===x.tokens.openParen){eatToken();if(true===lookaheadAndCheck(x.keywords.result)){eatToken();r=a.value;eatToken()}else{if(true!==lookaheadAndCheck(x.tokens.name)&&true!==lookaheadAndCheck(x.tokens.valtype)&&"keyword"!==a.type)throw function(){return new Error("\n"+(0,b.codeFrameFromSource)(n,a.loc)+"\n"+"Unexpected token in loop body"+", given "+tokenToString(a))}();o.push(parseFuncInstr())}eatTokenOfType(x.tokens.closeParen)}return C.loopInstruction(e,r,o)}function parseCallIndirect(){var e;var n=[];var r=[];var t=[];while(a.type!==x.tokens.closeParen){if(lookaheadAndCheck(x.tokens.openParen,x.keywords.type)){eatToken();eatToken();e=parseTypeReference()}else if(lookaheadAndCheck(x.tokens.openParen,x.keywords.param)){eatToken();eatToken();a.type!==x.tokens.closeParen&&n.push.apply(n,_toConsumableArray(parseFuncParam()))}else if(lookaheadAndCheck(x.tokens.openParen,x.keywords.result)){eatToken();eatToken();a.type!==x.tokens.closeParen&&r.push.apply(r,_toConsumableArray(parseFuncResult()))}else{eatTokenOfType(x.tokens.openParen);t.push(parseFuncInstr())}eatTokenOfType(x.tokens.closeParen)}return C.callIndirectInstruction(void 0!==e?e:C.signature(n,r),t)}function parseExport(){if(a.type!==x.tokens.string)throw new Error("Expected string after export, got: "+a.type);var e=a.value;eatToken();var n=parseModuleExportDescr();return C.moduleExport(e,n)}function parseModuleExportDescr(){var e=getStartLoc();var n="";var r;eatTokenOfType(x.tokens.openParen);while(a.type!==x.tokens.closeParen){if(isKeyword(a,x.keywords.func)){n="Func";eatToken();r=parseExportIndex(a)}else if(isKeyword(a,x.keywords.table)){n="Table";eatToken();r=parseExportIndex(a)}else if(isKeyword(a,x.keywords.global)){n="Global";eatToken();r=parseExportIndex(a)}else if(isKeyword(a,x.keywords.memory)){n="Memory";eatToken();r=parseExportIndex(a)}eatToken()}if(""===n)throw new Error("Unknown export type");if(void 0===r)throw new Error("Exported function must have a name");var t=C.moduleExportDescr(n,r);var o=getEndLoc();eatTokenOfType(x.tokens.closeParen);return C.withLoc(t,o,e)}function parseModule(){var n=null;var t=false;var i=false;var s=[];if(a.type===x.tokens.identifier){n=a.value;eatToken()}if(hasPlugin("wast")&&a.type===x.tokens.name&&"binary"===a.value){eatToken();t=true}if(hasPlugin("wast")&&a.type===x.tokens.name&&"quote"===a.value){eatToken();i=true}if(true===t){var k=[];while(a.type===x.tokens.string){k.push(a.value);eatToken();maybeIgnoreComment()}eatTokenOfType(x.tokens.closeParen);return C.binaryModule(n,k)}if(true===i){var l=[];while(a.type===x.tokens.string){l.push(a.value);eatToken()}eatTokenOfType(x.tokens.closeParen);return C.quoteModule(n,l)}while(a.type!==x.tokens.closeParen){s.push(walk());if(o.registredExportedElements.length>0){o.registredExportedElements.forEach((function(e){s.push(C.moduleExport(e.name,C.moduleExportDescr(e.exportType,e.id)))}));o.registredExportedElements=[]}a=e[r]}eatTokenOfType(x.tokens.closeParen);return C.module(n,s)}function parseFuncInstrArguments(e){var r=[];var t={};var o=0;while(a.type===x.tokens.name||isKeyword(a,x.keywords.offset)){var i=a.value;eatToken();eatTokenOfType(x.tokens.equal);var s=void 0;if(a.type!==x.tokens.number)throw new Error("Unexpected type for argument: "+a.type);s=C.numberLiteralFromRaw(a.value);t[i]=s;eatToken()}var k=e.vector?Infinity:e.length;while(a.type!==x.tokens.closeParen&&(a.type===x.tokens.openParen||o<k))if(a.type===x.tokens.identifier){r.push(C.identifier(a.value));eatToken()}else if(a.type===x.tokens.valtype){r.push(C.valtypeLiteral(a.value));eatToken()}else if(a.type===x.tokens.string){r.push(C.stringLiteral(a.value));eatToken()}else if(a.type===x.tokens.number){r.push(C.numberLiteralFromRaw(a.value,e[o]||"f64"));e.vector||++o;eatToken()}else{if(a.type!==x.tokens.openParen)throw function(){return new Error("\n"+(0,b.codeFrameFromSource)(n,a.loc)+"\n"+"Unexpected token in instruction argument"+", given "+tokenToString(a))}();eatToken();if(true!==lookaheadAndCheck(x.tokens.name)&&true!==lookaheadAndCheck(x.tokens.valtype)&&"keyword"!==a.type)throw function(){return new Error("\n"+(0,b.codeFrameFromSource)(n,a.loc)+"\n"+"Unexpected token in nested instruction"+", given "+tokenToString(a))}();r.push(parseFuncInstr());a.type===x.tokens.closeParen&&eatToken()}return{args:r,namedArgs:t}}function parseFuncInstr(){var e=getStartLoc();maybeIgnoreComment();if(a.type===x.tokens.name||a.type===x.tokens.valtype){var r=a.value;var t;eatToken();if(a.type===x.tokens.dot){t=r;eatToken();if(a.type!==x.tokens.name)throw new TypeError("Unknown token: "+a.type+", name expected");r=a.value;eatToken()}if(a.type===x.tokens.closeParen){var o=a.loc.end;return"undefined"===typeof t?C.withLoc(C.instruction(r),o,e):C.withLoc(C.objectInstruction(r,t,[]),o,e)}var i=C.signatureForOpcode(t||"",r);var s=parseFuncInstrArguments(i),k=s.args,l=s.namedArgs;var p=a.loc.end;return"undefined"===typeof t?C.withLoc(C.instruction(r,k,l),p,e):C.withLoc(C.objectInstruction(r,t,k,l),p,e)}if(isKeyword(a,x.keywords.loop)){eatToken();return parseLoop()}if(isKeyword(a,x.keywords.block)){eatToken();return parseBlock()}if(isKeyword(a,x.keywords.call_indirect)){eatToken();return parseCallIndirect()}if(isKeyword(a,x.keywords.call)){eatToken();var u;if(a.type===x.tokens.identifier){u=identifierFromToken(a);eatToken()}else if(a.type===x.tokens.number){u=C.indexLiteral(a.value);eatToken()}var c=[];while(a.type===x.tokens.openParen){eatToken();c.push(parseFuncInstr());eatTokenOfType(x.tokens.closeParen)}if("undefined"===typeof u)throw new Error("Missing argument in call instruciton");return c.length>0?C.callInstruction(u,c):C.callInstruction(u)}if(isKeyword(a,x.keywords.if)){eatToken();return parseIf()}if(isKeyword(a,x.keywords.module)&&hasPlugin("wast")){eatToken();var d=parseModule();return d}throw function(){return new Error("\n"+(0,b.codeFrameFromSource)(n,a.loc)+"\n"+"Unexpected instruction in function body"+", given "+tokenToString(a))}()}function parseFunc(){var e=C.identifier(t("func"));var r;var o=[];var i=[];var s=[];if(a.type===x.tokens.identifier){e=identifierFromToken(a);eatToken()}else e=C.withRaw(e,"");maybeIgnoreComment();while(a.type===x.tokens.openParen||a.type===x.tokens.name||a.type===x.tokens.valtype)if(a.type!==x.tokens.name&&a.type!==x.tokens.valtype){eatToken();if(true===lookaheadAndCheck(x.keywords.param)){eatToken();i.push.apply(i,_toConsumableArray(parseFuncParam()))}else if(true===lookaheadAndCheck(x.keywords.result)){eatToken();s.push.apply(s,_toConsumableArray(parseFuncResult()))}else if(true===lookaheadAndCheck(x.keywords.export)){eatToken();parseFuncExport(e)}else if(true===lookaheadAndCheck(x.keywords.type)){eatToken();r=parseTypeReference()}else{if(true!==lookaheadAndCheck(x.tokens.name)&&true!==lookaheadAndCheck(x.tokens.valtype)&&"keyword"!==a.type)throw function(){return new Error("\n"+(0,b.codeFrameFromSource)(n,a.loc)+"\n"+"Unexpected token in func body"+", given "+tokenToString(a))}();o.push(parseFuncInstr())}eatTokenOfType(x.tokens.closeParen)}else o.push(parseFuncInstr());return C.func(e,void 0!==r?r:C.signature(i,s),o)}function parseFuncExport(e){if(a.type!==x.tokens.string)throw function(){return new Error("\n"+(0,b.codeFrameFromSource)(n,a.loc)+"\n"+"Function export expected a string"+", given "+tokenToString(a))}();var r=a.value;eatToken();var t=C.identifier(e.value);o.registredExportedElements.push({exportType:"Func",name:r,id:t})}function parseType(){var e;var n=[];var r=[];if(a.type===x.tokens.identifier){e=identifierFromToken(a);eatToken()}if(lookaheadAndCheck(x.tokens.openParen,x.keywords.func)){eatToken();eatToken();if(a.type===x.tokens.closeParen){eatToken();return C.typeInstruction(e,C.signature([],[]))}if(lookaheadAndCheck(x.tokens.openParen,x.keywords.param)){eatToken();eatToken();n=parseFuncParam();eatTokenOfType(x.tokens.closeParen)}if(lookaheadAndCheck(x.tokens.openParen,x.keywords.result)){eatToken();eatToken();r=parseFuncResult();eatTokenOfType(x.tokens.closeParen)}eatTokenOfType(x.tokens.closeParen)}return C.typeInstruction(e,C.signature(n,r))}function parseFuncResult(){var e=[];while(a.type!==x.tokens.closeParen){if(a.type!==x.tokens.valtype)throw function(){return new Error("\n"+(0,b.codeFrameFromSource)(n,a.loc)+"\n"+"Unexpected token in func result"+", given "+tokenToString(a))}();var r=a.value;eatToken();e.push(r)}return e}function parseTypeReference(){var e;if(a.type===x.tokens.identifier){e=identifierFromToken(a);eatToken()}else if(a.type===x.tokens.number){e=C.numberLiteralFromRaw(a.value);eatToken()}return e}function parseGlobal(){var e=C.identifier(t("global"));var r;var i=null;maybeIgnoreComment();if(a.type===x.tokens.identifier){e=identifierFromToken(a);eatToken()}else e=C.withRaw(e,"");if(lookaheadAndCheck(x.tokens.openParen,x.keywords.export)){eatToken();eatToken();var s=a.value;eatTokenOfType(x.tokens.string);o.registredExportedElements.push({exportType:"Global",name:s,id:e});eatTokenOfType(x.tokens.closeParen)}if(lookaheadAndCheck(x.tokens.openParen,x.keywords.import)){eatToken();eatToken();var k=a.value;eatTokenOfType(x.tokens.string);var l=a.value;eatTokenOfType(x.tokens.string);i={module:k,name:l,descr:void 0};eatTokenOfType(x.tokens.closeParen)}if(a.type===x.tokens.valtype){r=C.globalType(a.value,"const");eatToken()}else if(a.type===x.tokens.openParen){eatToken();if(false===isKeyword(a,x.keywords.mut))throw function(){return new Error("\n"+(0,b.codeFrameFromSource)(n,a.loc)+"\n"+"Unsupported global type, expected mut"+", given "+tokenToString(a))}();eatToken();r=C.globalType(a.value,"var");eatToken();eatTokenOfType(x.tokens.closeParen)}if(void 0===r)throw function(){return new Error("\n"+(0,b.codeFrameFromSource)(n,a.loc)+"\n"+"Could not determine global type"+", given "+tokenToString(a))}();maybeIgnoreComment();var p=[];if(null!=i){i.descr=r;p.push(C.moduleImport(i.module,i.name,i.descr))}while(a.type===x.tokens.openParen){eatToken();p.push(parseFuncInstr());eatTokenOfType(x.tokens.closeParen)}return C.global(r,p,e)}function parseFuncParam(){var e=[];var n;var r;if(a.type===x.tokens.identifier){n=a.value;eatToken()}if(a.type===x.tokens.valtype){r=a.value;eatToken();e.push({id:n,valtype:r});if(void 0===n)while(a.type===x.tokens.valtype){r=a.value;eatToken();e.push({id:void 0,valtype:r})}}return e}function parseElem(){var e=C.indexLiteral(0);var r=[];var t=[];if(a.type===x.tokens.identifier){e=identifierFromToken(a);eatToken()}if(a.type===x.tokens.number){e=C.indexLiteral(a.value);eatToken()}while(a.type!==x.tokens.closeParen)if(lookaheadAndCheck(x.tokens.openParen,x.keywords.offset)){eatToken();eatToken();while(a.type!==x.tokens.closeParen){eatTokenOfType(x.tokens.openParen);r.push(parseFuncInstr());eatTokenOfType(x.tokens.closeParen)}eatTokenOfType(x.tokens.closeParen)}else if(a.type===x.tokens.identifier){t.push(C.identifier(a.value));eatToken()}else if(a.type===x.tokens.number){t.push(C.indexLiteral(a.value));eatToken()}else{if(a.type!==x.tokens.openParen)throw function(){return new Error("\n"+(0,b.codeFrameFromSource)(n,a.loc)+"\n"+"Unsupported token in elem"+", given "+tokenToString(a))}();eatToken();r.push(parseFuncInstr());eatTokenOfType(x.tokens.closeParen)}return C.elem(e,r,t)}function parseStart(){if(a.type===x.tokens.identifier){var e=identifierFromToken(a);eatToken();return C.start(e)}if(a.type===x.tokens.number){var n=C.indexLiteral(a.value);eatToken();return C.start(n)}throw new Error("Unknown start, token: "+tokenToString(a))}if(a.type===x.tokens.openParen){eatToken();var i=getStartLoc();if(isKeyword(a,x.keywords.export)){eatToken();var s=parseExport();var k=getEndLoc();return C.withLoc(s,k,i)}if(isKeyword(a,x.keywords.loop)){eatToken();var l=parseLoop();var p=getEndLoc();return C.withLoc(l,p,i)}if(isKeyword(a,x.keywords.func)){eatToken();var u=parseFunc();var c=getEndLoc();maybeIgnoreComment();eatTokenOfType(x.tokens.closeParen);return C.withLoc(u,c,i)}if(isKeyword(a,x.keywords.module)){eatToken();var d=parseModule();var f=getEndLoc();return C.withLoc(d,f,i)}if(isKeyword(a,x.keywords.import)){eatToken();var y=parseImport();var T=getEndLoc();eatTokenOfType(x.tokens.closeParen);return C.withLoc(y,T,i)}if(isKeyword(a,x.keywords.block)){eatToken();var v=parseBlock();var m=getEndLoc();eatTokenOfType(x.tokens.closeParen);return C.withLoc(v,m,i)}if(isKeyword(a,x.keywords.memory)){eatToken();var h=parseMemory();var w=getEndLoc();eatTokenOfType(x.tokens.closeParen);return C.withLoc(h,w,i)}if(isKeyword(a,x.keywords.data)){eatToken();var g=parseData();var E=getEndLoc();eatTokenOfType(x.tokens.closeParen);return C.withLoc(g,E,i)}if(isKeyword(a,x.keywords.table)){eatToken();var P=parseTable();var S=getEndLoc();eatTokenOfType(x.tokens.closeParen);return C.withLoc(P,S,i)}if(isKeyword(a,x.keywords.global)){eatToken();var A=parseGlobal();var _=getEndLoc();eatTokenOfType(x.tokens.closeParen);return C.withLoc(A,_,i)}if(isKeyword(a,x.keywords.type)){eatToken();var I=parseType();var L=getEndLoc();eatTokenOfType(x.tokens.closeParen);return C.withLoc(I,L,i)}if(isKeyword(a,x.keywords.start)){eatToken();var R=parseStart();var K=getEndLoc();eatTokenOfType(x.tokens.closeParen);return C.withLoc(R,K,i)}if(isKeyword(a,x.keywords.elem)){eatToken();var D=parseElem();var X=getEndLoc();eatTokenOfType(x.tokens.closeParen);return C.withLoc(D,X,i)}var j=parseFuncInstr();var N=getEndLoc();maybeIgnoreComment();if("object"===_typeof(j)){"undefined"!==typeof a&&eatTokenOfType(x.tokens.closeParen);return C.withLoc(j,N,i)}}if(a.type===x.tokens.comment){var U=getStartLoc();var M="leading"===a.opts.type?C.leadingComment:C.blockComment;var H=M(a.value);eatToken();var q=getEndLoc();return C.withLoc(H,q,U)}throw function(){return new Error("\n"+(0,b.codeFrameFromSource)(n,a.loc)+"\n"+"Unknown token"+", given "+tokenToString(a))}()}var a=[];while(r<e.length)a.push(walk());return C.program(a)}var S={};Object.defineProperty(S,"__esModule",{value:true});var A={parse:true};S.parse=parse$1;var _=_interopRequireWildcard$1(P);var I=k;var L=r;Object.keys(L).forEach((function(e){"default"!==e&&"__esModule"!==e&&(Object.prototype.hasOwnProperty.call(A,e)||Object.defineProperty(S,e,{enumerable:true,get:function get(){return L[e]}}))}));function _interopRequireWildcard$1(e){if(e&&e.__esModule)return e;var n={};if(null!=e)for(var r in e)if(Object.prototype.hasOwnProperty.call(e,r)){var t=Object.defineProperty&&Object.getOwnPropertyDescriptor?Object.getOwnPropertyDescriptor(e,r):{};t.get||t.set?Object.defineProperty(n,r,t):n[r]=e[r]}n.default=e;return n}function parse$1(e){var n=(0,I.tokenize)(e);var r=_.parse(n,e);return r}const R=S.__esModule;const K=S.parse;export default S;export{R as __esModule,K as parse};

