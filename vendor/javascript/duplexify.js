import e from"readable-stream";import t from"end-of-stream";import r from"inherits";import i from"stream-shift";import n from"process";import s from"buffer";var a="undefined"!==typeof globalThis?globalThis:"undefined"!==typeof self?self:global;var o={};var d=s.Buffer;var l=n;var h=e;var f=t;var u=r;var _=i;var c=d.from&&d.from!==Uint8Array.from?d.from([0]):new d([0]);var onuncork=function(e,t){e._corked?e.once("uncork",t):t()};var autoDestroy=function(e,t){e._autoDestroy&&e.destroy(t)};var destroyer=function(e,t){return function(r){r?autoDestroy(e,"premature close"===r.message?null:r):t&&!e._ended&&e.end()}};var end=function(e,t){if(!e)return t();if(e._writableState&&e._writableState.finished)return t();if(e._writableState)return e.end(t);e.end();t()};var toStreams2=function(e){return new h.Readable({objectMode:true,highWaterMark:16}).wrap(e)};var Duplexify=function(e,t,r){if(!((this||a)instanceof Duplexify))return new Duplexify(e,t,r);h.Duplex.call(this||a,r);(this||a)._writable=null;(this||a)._readable=null;(this||a)._readable2=null;(this||a)._autoDestroy=!r||false!==r.autoDestroy;(this||a)._forwardDestroy=!r||false!==r.destroy;(this||a)._forwardEnd=!r||false!==r.end;(this||a)._corked=1;(this||a)._ondrain=null;(this||a)._drained=false;(this||a)._forwarding=false;(this||a)._unwrite=null;(this||a)._unread=null;(this||a)._ended=false;(this||a).destroyed=false;e&&this.setWritable(e);t&&this.setReadable(t)};u(Duplexify,h.Duplex);Duplexify.obj=function(e,t,r){r||(r={});r.objectMode=true;r.highWaterMark=16;return new Duplexify(e,t,r)};Duplexify.prototype.cork=function(){1===++(this||a)._corked&&this.emit("cork")};Duplexify.prototype.uncork=function(){(this||a)._corked&&0===--(this||a)._corked&&this.emit("uncork")};Duplexify.prototype.setWritable=function(e){(this||a)._unwrite&&this._unwrite();if((this||a).destroyed)e&&e.destroy&&e.destroy();else if(null!==e&&false!==e){var t=this||a;var r=f(e,{writable:true,readable:false},destroyer(this||a,(this||a)._forwardEnd));var ondrain=function(){var e=t._ondrain;t._ondrain=null;e&&e()};var clear=function(){t._writable.removeListener("drain",ondrain);r()};(this||a)._unwrite&&l.nextTick(ondrain);(this||a)._writable=e;(this||a)._writable.on("drain",ondrain);(this||a)._unwrite=clear;this.uncork()}else this.end()};Duplexify.prototype.setReadable=function(e){(this||a)._unread&&this._unread();if((this||a).destroyed)e&&e.destroy&&e.destroy();else if(null!==e&&false!==e){var t=this||a;var r=f(e,{writable:false,readable:true},destroyer(this||a));var onreadable=function(){t._forward()};var onend=function(){t.push(null)};var clear=function(){t._readable2.removeListener("readable",onreadable);t._readable2.removeListener("end",onend);r()};(this||a)._drained=true;(this||a)._readable=e;(this||a)._readable2=e._readableState?e:toStreams2(e);(this||a)._readable2.on("readable",onreadable);(this||a)._readable2.on("end",onend);(this||a)._unread=clear;this._forward()}else{this.push(null);this.resume()}};Duplexify.prototype._read=function(){(this||a)._drained=true;this._forward()};Duplexify.prototype._forward=function(){if(!(this||a)._forwarding&&(this||a)._readable2&&(this||a)._drained){(this||a)._forwarding=true;var e;while((this||a)._drained&&null!==(e=_((this||a)._readable2)))(this||a).destroyed||((this||a)._drained=this.push(e));(this||a)._forwarding=false}};Duplexify.prototype.destroy=function(e){if(!(this||a).destroyed){(this||a).destroyed=true;var t=this||a;l.nextTick((function(){t._destroy(e)}))}};Duplexify.prototype._destroy=function(e){if(e){var t=(this||a)._ondrain;(this||a)._ondrain=null;t?t(e):this.emit("error",e)}if((this||a)._forwardDestroy){(this||a)._readable&&(this||a)._readable.destroy&&(this||a)._readable.destroy();(this||a)._writable&&(this||a)._writable.destroy&&(this||a)._writable.destroy()}this.emit("close")};Duplexify.prototype._write=function(e,t,r){if((this||a).destroyed)return r();if((this||a)._corked)return onuncork(this||a,(this||a)._write.bind(this||a,e,t,r));if(e===c)return this._finish(r);if(!(this||a)._writable)return r();false===(this||a)._writable.write(e)?(this||a)._ondrain=r:r()};Duplexify.prototype._finish=function(e){var t=this||a;this.emit("preend");onuncork(this||a,(function(){end(t._forwardEnd&&t._writable,(function(){false===t._writableState.prefinished&&(t._writableState.prefinished=true);t.emit("prefinish");onuncork(t,e)}))}))};Duplexify.prototype.end=function(e,t,r){if("function"===typeof e)return this.end(null,null,e);if("function"===typeof t)return this.end(e,null,t);(this||a)._ended=true;e&&this.write(e);(this||a)._writableState.ending||this.write(c);return h.Writable.prototype.end.call(this||a,r)};o=Duplexify;var b=o;export default b;

