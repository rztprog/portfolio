import r from"fs";import e from"path";import o from"aproba";import i from"fs-write-stream-atomic";import t from"mkdirp";import n from"rimraf";import s from"process";import a from"run-queue";import c from"util";var u={};var m=s;u="win32"===m.platform;var d=u;var f="undefined"!==typeof globalThis?globalThis:"undefined"!==typeof self?self:global;var p={};var l=s;p=copy;p.item=copyItem;p.recurse=recurseDir;p.symlink=copySymlink;p.file=copyFile;var v=r;var y=e;var h=o;var w=i;var k=t;var P=n;var S=d;var E=a;var g=Object.assign||c._extend;function promisify(r,e){return function(){var o=[].slice.call(arguments);return new r((function(r,i){return e.apply(null,o.concat((function(e,o){e?i(e):r(o)})))}))}}function copy(r,e,o){h("SSO|SS",arguments);o=g({},o||{});var i=o.Promise||f.Promise;var t=o.fs||v;null==o.isWindows&&(o.isWindows=S);o.Promise||(o.Promise=i);o.fs||(o.fs=t);o.recurseWith||(o.recurseWith=copyItem);o.lstat||(o.lstat=promisify(o.Promise,t.lstat));o.stat||(o.stat=promisify(o.Promise,t.stat));o.chown||(o.chown=promisify(o.Promise,t.chown));o.readdir||(o.readdir=promisify(o.Promise,t.readdir));o.readlink||(o.readlink=promisify(o.Promise,t.readlink));o.symlink||(o.symlink=promisify(o.Promise,t.symlink));o.chmod||(o.chmod=promisify(o.Promise,t.chmod));o.top=r;o.mkdirpAsync=promisify(o.Promise,k);var n=promisify(o.Promise,P);var s=new E({maxConcurrency:o.maxConcurrency,Promise:i});o.queue=s;s.add(0,copyItem,[r,e,o]);return s.run().catch((function(r){return"EEXIST"===r.code||"EPERM"===r.code?passThroughError():remove(e).then(passThroughError,passThroughError);function passThroughError(){return i.reject(r)}}));function remove(r){var e={unlink:t.unlink,chmod:t.chmod,stat:t.stat,lstat:t.lstat,rmdir:t.rmdir,readdir:t.readdir,glob:false};return n(r,e)}}function copyItem(r,e,o){h("SSO",[r,e,o]);var i=o.fs||v;var t=o.Promise||f.Promise;var n=o.lstat||promisify(t,i.lstat);return n(e).then((function(){return t.reject(eexists(r,e))}),(function(e){return e&&"ENOENT"!==e.code?t.reject(e):n(r)})).then((function(i){var n=g(g({},o),i);if(i.isDirectory())return recurseDir(r,e,n);if(!i.isSymbolicLink())return i.isFile()?copyFile(r,e,n):i.isBlockDevice()?t.reject(eunsupported(r+" is a block device, and we don't know how to copy those.")):i.isCharacterDevice()?t.reject(eunsupported(r+" is a character device, and we don't know how to copy those.")):i.isFIFO()?t.reject(eunsupported(r+" is a FIFO, and we don't know how to copy those.")):i.isSocket()?t.reject(eunsupported(r+" is a socket, and we don't know how to copy those.")):t.reject(eunsupported("We can't tell what "+r+" is and so we can't copy it."));o.queue.add(1,copySymlink,[r,e,n])}))}function recurseDir(r,e,o){h("SSO",[r,e,o]);var i=o.recurseWith||copyItem;var t=o.fs||v;var n=o.chown||promisify(Promise,t.chown);var s=o.readdir||promisify(Promise,t.readdir);var a=o.mkdirpAsync||promisify(Promise,k);return a(e,{fs:t,mode:o.mode}).then((function(){var r=o.getuid||l.getuid;if(r&&null!=o.uid&&0===r())return n(e,o.uid,o.gid)})).then((function(){return s(r)})).then((function(t){t.forEach((function(t){o.queue.add(0,i,[y.join(r,t),y.join(e,t),o])}))}))}function copySymlink(r,e,o){h("SSO",[r,e,o]);var i=o.fs||v;var t=o.readlink||promisify(a,i.readlink);var n=o.stat||promisify(a,i.symlink);var s=o.symlink||promisify(a,i.symlink);var a=o.Promise||f.Promise;return t(r).then((function(i){var t=y.resolve(y.dirname(r),i);var c=y.relative(o.top,t);var u=".."===c.substr(0,2)?i:y.relative(y.dirname(r),t);return o.isWindows?n(t).catch((function(){return null})).then((function(r){var o=r&&r.isDirectory();var i=o?"dir":"file";return s(u,e,i).catch((function(r){return"dir"===i?s(u,e,"junction"):a.reject(r)}))})):s(u,e)}))}function copyFile(r,e,o){h("SSO",[r,e,o]);var i=o.fs||v;var t=o.writeStreamAtomic||w;var n=o.Promise||f.Promise;var s=o.chmod||promisify(n,i.chmod);var a={};var c=o.getuid||l.getuid;c&&null!=o.uid&&0===c()&&(a.chown={uid:o.uid,gid:o.gid});return new n((function(n,c){var u=false;function onError(r){u=true;c(r)}i.createReadStream(r).once("error",onError).pipe(t(e,a)).once("error",onError).once("close",(function(){u||(null!=o.mode?n(s(e,o.mode)):n())}))}))}function eexists(r,e){var o=new Error("Could not move "+r+" to "+e+": destination already exists.");o.code="EEXIST";return o}function eunsupported(r){var e=new Error(r);e.code="EUNSUPPORTED";return e}var j=p;const O=p.item,T=p.recurse,b=p.symlink,I=p.file;export default j;export{I as file,O as item,T as recurse,b as symlink};

