import e from"@webassemblyjs/ast";var t={};Object.defineProperty(t,"__esModule",{value:true});t.moduleContextFromModuleAST=moduleContextFromModuleAST;t.ModuleContext=void 0;var n=e;function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function _defineProperties(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||false;r.configurable=true;"value"in r&&(r.writable=true);Object.defineProperty(e,r.key,r)}}function _createClass(e,t,n){t&&_defineProperties(e.prototype,t);n&&_defineProperties(e,n);return e}function moduleContextFromModuleAST(e){var t=new r;if(!("Module"===e.type))throw new Error('m.type === "Module"'+" error: "+(void 0||"unknown"));e.fields.forEach((function(e){switch(e.type){case"Start":t.setStart(e.index);break;case"TypeInstruction":t.addType(e);break;case"Func":t.addFunction(e);break;case"Global":t.defineGlobal(e);break;case"ModuleImport":switch(e.descr.type){case"GlobalType":t.importGlobal(e.descr.valtype,e.descr.mutability);break;case"Memory":t.addMemory(e.descr.limits.min,e.descr.limits.max);break;case"FuncImportDescr":t.importFunction(e.descr);break;case"Table":break;default:throw new Error("Unsupported ModuleImport of type "+JSON.stringify(e.descr.type))}break;case"Memory":t.addMemory(e.limits.min,e.limits.max);break}}));return t}var r=function(){function ModuleContext(){_classCallCheck(this,ModuleContext);this.funcs=[];this.funcsOffsetByIdentifier=[];this.types=[];this.globals=[];this.globalsOffsetByIdentifier=[];this.mems=[];this.locals=[];this.labels=[];this.return=[];this.debugName="unknown";this.start=null}_createClass(ModuleContext,[{key:"setStart",value:function setStart(e){this.start=e.value}},{key:"getStart",value:function getStart(){return this.start}},{key:"newContext",value:function newContext(e,t){this.locals=[];this.labels=[t];this.return=t;this.debugName=e}},{key:"addFunction",value:function addFunction(e){var t=e.signature||{},n=t.params,r=void 0===n?[]:n,a=t.results,o=void 0===a?[]:a;r=r.map((function(e){return e.valtype}));this.funcs.push({args:r,result:o});"undefined"!==typeof e.name&&(this.funcsOffsetByIdentifier[e.name.value]=this.funcs.length-1)}},{key:"importFunction",value:function importFunction(e){if((0,n.isSignature)(e.signature)){var t=e.signature,r=t.params,a=t.results;r=r.map((function(e){return e.valtype}));this.funcs.push({args:r,result:a})}else{if(!(0,n.isNumberLiteral)(e.signature))throw new Error("isNumberLiteral(funcimport.signature)"+" error: "+(void 0||"unknown"));var o=e.signature.value;if(!this.hasType(o))throw new Error("this.hasType(typeId)"+" error: "+(void 0||"unknown"));var i=this.getType(o);this.funcs.push({args:i.params.map((function(e){return e.valtype})),result:i.results})}"undefined"!==typeof e.id&&(this.funcsOffsetByIdentifier[e.id.value]=this.funcs.length-1)}},{key:"hasFunction",value:function hasFunction(e){return"undefined"!==typeof this.getFunction(e)}},{key:"getFunction",value:function getFunction(e){if("number"!==typeof e)throw new Error("getFunction only supported for number index");return this.funcs[e]}},{key:"getFunctionOffsetByIdentifier",value:function getFunctionOffsetByIdentifier(e){if(!("string"===typeof e))throw new Error('typeof name === "string"'+" error: "+(void 0||"unknown"));return this.funcsOffsetByIdentifier[e]}},{key:"addLabel",value:function addLabel(e){this.labels.unshift(e)}},{key:"hasLabel",value:function hasLabel(e){return this.labels.length>e&&e>=0}},{key:"getLabel",value:function getLabel(e){return this.labels[e]}},{key:"popLabel",value:function popLabel(){this.labels.shift()}},{key:"hasLocal",value:function hasLocal(e){return"undefined"!==typeof this.getLocal(e)}},{key:"getLocal",value:function getLocal(e){return this.locals[e]}},{key:"addLocal",value:function addLocal(e){this.locals.push(e)}},{key:"addType",value:function addType(e){if(!("Signature"===e.functype.type))throw new Error('type.functype.type === "Signature"'+" error: "+(void 0||"unknown"));this.types.push(e.functype)}},{key:"hasType",value:function hasType(e){return void 0!==this.types[e]}},{key:"getType",value:function getType(e){return this.types[e]}},{key:"hasGlobal",value:function hasGlobal(e){return this.globals.length>e&&e>=0}},{key:"getGlobal",value:function getGlobal(e){return this.globals[e].type}},{key:"getGlobalOffsetByIdentifier",value:function getGlobalOffsetByIdentifier(e){if(!("string"===typeof e))throw new Error('typeof name === "string"'+" error: "+(void 0||"unknown"));return this.globalsOffsetByIdentifier[e]}},{key:"defineGlobal",value:function defineGlobal(e){var t=e.globalType.valtype;var n=e.globalType.mutability;this.globals.push({type:t,mutability:n});"undefined"!==typeof e.name&&(this.globalsOffsetByIdentifier[e.name.value]=this.globals.length-1)}},{key:"importGlobal",value:function importGlobal(e,t){this.globals.push({type:e,mutability:t})}},{key:"isMutableGlobal",value:function isMutableGlobal(e){return"var"===this.globals[e].mutability}},{key:"isImmutableGlobal",value:function isImmutableGlobal(e){return"const"===this.globals[e].mutability}},{key:"hasMemory",value:function hasMemory(e){return this.mems.length>e&&e>=0}},{key:"addMemory",value:function addMemory(e,t){this.mems.push({min:e,max:t})}},{key:"getMemory",value:function getMemory(e){return this.mems[e]}}]);return ModuleContext}();t.ModuleContext=r;const a=t.__esModule;const o=t.moduleContextFromModuleAST,i=t.ModuleContext;export default t;export{i as ModuleContext,a as __esModule,o as moduleContextFromModuleAST};

